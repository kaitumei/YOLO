{% extends "common/cms_base.html" %}

{% block title %}【HorizonSafe 界安】---后台用户管理{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='cms/css/staff_list.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='cms/css/add_staff.css') }}">
{% endblock %}

{% block content %}
<div class="management-container">
    <!-- 主内容区域 -->
    <main class="main-content">
        <div class="toolbar">
            <h2 class="section-title">后台用户管理</h2>
            <a href="{{ url_for('cms.add_staff') }}" class="primary-button with-icon">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                添加员工
            </a>
        </div>

        <!-- 搜索框 -->
        <div class="search-container">
            <form method="GET" action="{{ url_for('cms.staff_list') }}" class="search-form">
                <div class="search-input-group">
                    <input type="text" name="search" placeholder="搜索用户名、邮箱或手机号" value="{{ search }}">
                    <button type="submit" class="search-button">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        搜索
                    </button>
                </div>
            </form>
        </div>

        <div class="card animate-fade-in">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th class="hide-mobile">联系方式</th>
                            <th>创建时间</th>
                            <th>权限</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for user in users %}
                        <tr>
                            <td data-label="用户名">{{ user.username }}</td>
                            <td data-label="联系方式" class="hide-mobile">{{ user.email }}</td>
                            <td data-label="创建时间">{{ user.join_time }}</td>
                            <td data-label="权限">
                                <span class="role-tag">{{ user.role.name }}</span>
                            </td>
                            <td data-label="操作">
                                {% if not user.has_permission(PermissionEnum.CMS_USER) %}
                                <button class="icon-button edit-permission-btn" 
                                        aria-label="编辑权限" 
                                        data-user-id="{{ user.id }}"
                                        data-username="{{ user.username }}"
                                        data-email="{{ user.email }}"
                                        data-phone="{{ user.phone }}"
                                        data-role="{{ user.role.name if user.role else '无角色' }}">
                                    <svg viewBox="0 0 24 24" width="18" height="18">
                                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                                    </svg>
                                    <span class="tooltip">编辑权限</span>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 分页 -->
  
        <div class="pagination-wrapper">
            <a href="{{ url_for('cms.staff_list', page=pagination.prev_num, search=search) }}" 
               class="btn btn-outline btn-secondary prev" 
               {% if not pagination.has_prev %}disabled{% endif %}>
                <i class="fas fa-chevron-left"></i>
                上一页
            </a>
            <div class="page-info">第 {{ current_page }} 页 / 共 {{ total_pages }} 页</div>
            <a href="{{ url_for('cms.staff_list', page=pagination.next_num, search=search) }}" 
               class="btn btn-outline btn-secondary next" 
               {% if not pagination.has_next %}disabled{% endif %}>
                下一页
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </main>
</div>

<!-- 权限编辑模态框 -->
<div class="modal" id="permissionModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>修改用户权限</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="permissionForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="user_id" name="user_id">
                
                <div class="form-group">
                    <label>用户信息</label>
                    <div class="user-info-display">
                        <div class="user-name" id="userNameDisplay"></div>
                        <div class="user-email" id="userEmailDisplay"></div>
                        <div class="user-phone" id="userPhoneDisplay"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="role_select">用户角色</label>
                    <select id="role_select" name="role_id" required>
                        <option value="">请选择用户角色</option>
                        {% for role in all_roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-secondary">不同角色拥有不同的权限</small>
                </div>
                
                <div class="form-group">
                    <label>当前权限</label>
                    <div class="permissions-list" id="permissionsList">
                        <div class="permission-placeholder">加载中...</div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="button" id="savePermissionBtn">
                        <span class="button-text">保存修改</span>
                    </button>
                    <button type="button" class="cancel" id="cancelPermissionBtn">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 权限编辑模态框逻辑
        const modal = document.getElementById("permissionModal");
        const permissionForm = document.getElementById("permissionForm");
        const userIdInput = document.getElementById("user_id");
        const userNameDisplay = document.getElementById("userNameDisplay");
        const userEmailDisplay = document.getElementById("userEmailDisplay");
        const userPhoneDisplay = document.getElementById("userPhoneDisplay");
        const roleSelect = document.getElementById("role_select");
        const permissionsList = document.getElementById("permissionsList");
        const savePermissionBtn = document.getElementById("savePermissionBtn");
        const cancelPermissionBtn = document.getElementById("cancelPermissionBtn");
        const closeModalBtn = document.querySelector(".close-modal");

        // 打开模态框
        document.querySelectorAll('.edit-permission-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const username = this.dataset.username;
                const email = this.dataset.email;
                const phone = this.dataset.phone;
                
                userIdInput.value = userId;
                userNameDisplay.textContent = username;
                userEmailDisplay.textContent = email;
                userPhoneDisplay.textContent = phone || '无';
                
                // 加载用户权限
                loadUserPermissions(userId);
                
                // 显示模态框
                modal.style.display = "block";
                document.body.classList.add("modal-open");
            });
        });

        // 关闭模态框
        function closeModal() {
            modal.style.display = "none";
            document.body.classList.remove("modal-open");
            permissionForm.reset();
            permissionsList.innerHTML = '<div class="permission-placeholder">加载中...</div>';
        }

        closeModalBtn.addEventListener('click', closeModal);
        cancelPermissionBtn.addEventListener('click', closeModal);
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal();
            }
        });

        // 加载用户权限
        function loadUserPermissions(userId) {
            permissionsList.innerHTML = '<div class="permission-placeholder">加载中...</div>';
            
            fetch(`/cms/user/${userId}/permissions`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取权限失败');
                    }
                    return response.json();
                })
                .then(data => {
                    // 设置角色选择
                    if (data.data && data.data.role_id) {
                        roleSelect.value = data.data.role_id;
                    }
                    
                    // 更新权限列表
                    if (data.data && data.data.permissions) {
                        updatePermissionsList(data.data.permissions);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    permissionsList.innerHTML = '<div class="permission-placeholder">获取权限失败，请重试</div>';
                });
        }

        // 更新权限列表
        function updatePermissionsList(permissions) {
            if (!permissions || permissions.length === 0) {
                permissionsList.innerHTML = '<div class="permission-placeholder">该用户暂无权限</div>';
                return;
            }
            
            const html = permissions.map(permission => `
                <div class="permission-item">
                    <span class="permission-name">${permission.name}</span>
                    <span class="permission-desc">${permission.description || '无描述'}</span>
                </div>
            `).join('');
            
            permissionsList.innerHTML = html;
        }

        // 角色变更时更新权限列表
        roleSelect.addEventListener('change', function() {
            const roleId = this.value;
            if (!roleId) {
                permissionsList.innerHTML = '<div class="permission-placeholder">请选择角色</div>';
                return;
            }
            
            fetch(`/cms/role/${roleId}/permissions`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取角色权限失败');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.data && data.data.permissions) {
                        updatePermissionsList(data.data.permissions);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    permissionsList.innerHTML = '<div class="permission-placeholder">获取权限失败，请重试</div>';
                });
        });

        // 提交权限修改
        permissionForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const userId = userIdInput.value;
            const roleId = roleSelect.value;
            
            if (!roleId) {
                showError('请选择用户角色');
                return;
            }
            
            // 显示加载状态
            savePermissionBtn.classList.add('loading');
            savePermissionBtn.disabled = true;
            
            fetch(`/cms/user/${userId}/update-role`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: `role_id=${roleId}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('更新失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    // 更新成功，刷新页面
                    window.location.reload();
                } else {
                    showError(data.message || '更新失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('更新失败，请稍后重试');
            })
            .finally(() => {
                savePermissionBtn.classList.remove('loading');
                savePermissionBtn.disabled = false;
            });
        });

        // 显示错误提示
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = message;
            
            const modalBody = document.querySelector('.modal-body');
            modalBody.insertBefore(errorDiv, modalBody.firstChild);
            
            // 3秒后自动消失
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }
    });
</script>
{% endblock %}