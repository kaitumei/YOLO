{% extends 'common/cms_base.html' %}

{% block title %}用户日志管理{% endblock %}

{% block css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='cms/css/logs.css') }}">
{% endblock %}

{% block content %}
<div class="logs-container">
    <div class="logs-header">
        <h1>用户日志管理</h1>
    </div>
    
    <div class="filters-container">
        <form action="{{ url_for('cms.logs_list') }}" method="get" class="filter-form">
            <div class="filter-group">
                <label for="user_id">用户</label>
                <select name="user_id" id="user_id">
                    <option value="">全部用户</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if current_user_id == user.id %}selected{% endif %}>
                        {{ user.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="action">操作类型</label>
                <select name="action" id="action">
                    <option value="">全部操作</option>
                    {% for action_type in action_types %}
                    <option value="{{ action_type }}" {% if current_action == action_type %}selected{% endif %}>
                        {{ action_type }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="start_date">开始日期</label>
                <input type="text" name="start_date" id="start_date" class="date-picker" placeholder="YYYY-MM-DD" value="{{ current_start_date }}">
            </div>
            
            <div class="filter-group">
                <label for="end_date">结束日期</label>
                <input type="text" name="end_date" id="end_date" class="date-picker" placeholder="YYYY-MM-DD" value="{{ current_end_date }}">
            </div>
            
            <div class="filter-group">
                <label for="per_page">每页显示</label>
                <select name="per_page" id="per_page">
                    <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10条</option>
                    <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20条</option>
                    <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50条</option>
                    <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100条</option>
                </select>
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn-filter">筛选</button>
                <a href="{{ url_for('cms.logs_list') }}" class="btn-reset">重置</a>
            </div>
        </form>
    </div>
    
    {% if logs %}
    <div class="table-container">
        <table class="logs-table">
            <thead>
                <tr>
                    <th data-label="ID">
                        <div class="th-content">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2zm12 4c0 1.66-1.34 3-3 3s-3-1.34-3-3 1.34-3 3-3 3 1.34 3 3zm-9 8c0-2 4-3.1 6-3.1s6 1.1 6 3.1v1H6v-1z"/>
                            </svg>
                            <span>ID</span>
                        </div>
                    </th>
                    <th data-label="用户">
                        <div class="th-content">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            <span>用户</span>
                        </div>
                    </th>
                    <th data-label="操作类型">
                        <div class="th-content">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                            </svg>
                            <span>操作类型</span>
                        </div>
                    </th>
                    <th data-label="IP地址">
                        <div class="th-content">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                            </svg>
                            <span>IP地址</span>
                        </div>
                    </th>
                    <th data-label="设备信息">
                        <div class="th-content">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M4 6h18V4H4c-1.1 0-2 .9-2 2v11H0v3h14v-3H4V6zm19 2h-6c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1zm-1 9h-4v-7h4v7z"/>
                            </svg>
                            <span>设备信息</span>
                        </div>
                    </th>
                    <th data-label="操作时间">
                        <div class="th-content">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                            </svg>
                            <span>操作时间</span>
                        </div>
                    </th>
                    <th data-label="操作">
                        <div class="th-content">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                            <span>操作</span>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td data-label="ID">{{ log.id }}</td>
                    <td data-label="用户">
                        {% set log_user = log.user %}
                        {% if log_user %}
                            {{ log_user.username }}
                        {% else %}
                            未知用户
                        {% endif %}
                    </td>
                    <td data-label="操作类型">
                        <span class="action-badge 
                            {% if log.action == '登录' %}action-login
                            {% elif log.action == '注册' %}action-register
                            {% elif log.action == '修改密码' %}action-password
                            {% elif log.action == '编辑资料' %}action-edit
                            {% elif log.action == '删除' %}action-delete
                            {% else %}action-other{% endif %}">
                            {{ log.action }}
                        </span>
                    </td>
                    <td data-label="IP地址">{{ log.ip_address or '未知' }}</td>
                    <td data-label="设备信息">{{ log.device_info or '未知' }}</td>
                    <td data-label="操作时间">{{ log.create_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td data-label="操作" class="action-cell">
                        <a href="{{ url_for('cms.log_detail', log_id=log.id) }}" class="action-icon view-icon" title="查看详情">
                            <svg viewBox="0 0 24 24" width="18" height="18">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                            <span class="action-text">详情</span>
                        </a>
                        <a href="javascript:void(0)" class="action-icon delete-icon" title="删除日志" data-log-id="{{ log.id }}">
                            <svg viewBox="0 0 24 24" width="18" height="18">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                            <span class="action-text">删除</span>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 分页 -->
    {% if pagination.pages > 1 %}
    <div class="pagination-container">
        <ul class="pagination">
            {% if pagination.has_prev %}
            <li>
                <a href="{{ url_for('cms.logs_list', page=pagination.prev_num, user_id=current_user_id, action=current_action, start_date=current_start_date, end_date=current_end_date, per_page=pagination.per_page) }}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}
            
            {% set start_page = [1, pagination.page - 2]|max %}
            {% set end_page = [pagination.pages, pagination.page + 2]|min %}
            
            {% if start_page > 1 %}
            <li><a href="{{ url_for('cms.logs_list', page=1, user_id=current_user_id, action=current_action, start_date=current_start_date, end_date=current_end_date, per_page=pagination.per_page) }}">1</a></li>
            {% if start_page > 2 %}
            <li><span>...</span></li>
            {% endif %}
            {% endif %}
            
            {% for page_num in range(start_page, end_page + 1) %}
            <li {% if page_num == pagination.page %}class="active"{% endif %}>
                {% if page_num == pagination.page %}
                <span>{{ page_num }}</span>
                {% else %}
                <a href="{{ url_for('cms.logs_list', page=page_num, user_id=current_user_id, action=current_action, start_date=current_start_date, end_date=current_end_date, per_page=pagination.per_page) }}">{{ page_num }}</a>
                {% endif %}
            </li>
            {% endfor %}
            
            {% if end_page < pagination.pages %}
            {% if end_page < pagination.pages - 1 %}
            <li><span>...</span></li>
            {% endif %}
            <li><a href="{{ url_for('cms.logs_list', page=pagination.pages, user_id=current_user_id, action=current_action, start_date=current_start_date, end_date=current_end_date, per_page=pagination.per_page) }}">{{ pagination.pages }}</a></li>
            {% endif %}
            
            {% if pagination.has_next %}
            <li>
                <a href="{{ url_for('cms.logs_list', page=pagination.next_num, user_id=current_user_id, action=current_action, start_date=current_start_date, end_date=current_end_date, per_page=pagination.per_page) }}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
    
    <!-- 清除日志 -->
    <div class="clear-logs-container">
        <h2 class="clear-logs-title">清除日志</h2>
        <form action="{{ url_for('cms.clear_logs') }}" method="post" class="clear-logs-form" id="clear-logs-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="filter-group">
                <label for="clear_days">清除多少天前的日志</label>
                <select name="days" id="clear_days">
                    <option value="7">7天前</option>
                    <option value="30">30天前</option>
                    <option value="90">90天前</option>
                    <option value="365">一年前</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="clear_user_id">用户</label>
                <select name="user_id" id="clear_user_id">
                    <option value="">全部用户</option>
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="clear_action">操作类型</label>
                <select name="action" id="clear_action">
                    <option value="">全部操作</option>
                    {% for action_type in action_types %}
                    <option value="{{ action_type }}">{{ action_type }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button type="button" class="btn-danger" onclick="confirmClearLogs()">
                <i class="fas fa-trash"></i> 清除日志
            </button>
        </form>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-history"></i>
        <h3>暂无日志记录</h3>
        <p>系统尚未记录任何用户操作日志</p>
    </div>
    {% endif %}
    
    <!-- 删除确认模态框 -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="close-modal" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>您确定要删除此日志记录吗？此操作无法撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-reset" onclick="closeModal()">取消</button>
                <form id="deleteForm" method="post" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn-danger">删除</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 清除日志确认模态框 -->
    <div class="modal" id="clearLogsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认清除日志</h5>
                <button type="button" class="close-modal" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>您确定要清除符合条件的日志记录吗？此操作无法撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-reset" onclick="closeModal()">取消</button>
                <button type="button" class="btn-danger" onclick="submitClearLogs()">清除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
<script>
    // 初始化日期选择器
    flatpickr(".date-picker", {
        dateFormat: "Y-m-d",
        locale: "zh"
    });
    
    // 显示模态框
    function showModal(modalId) {
        document.getElementById(modalId).classList.add('show');
        document.body.classList.add('modal-open');
    }
    
    // 关闭所有模态框
    function closeModal() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.remove('show');
        });
        document.body.classList.remove('modal-open');
    }
    
    // 确认删除
    function confirmDelete(logId) {
        document.getElementById('deleteForm').action = "{{ url_for('cms.delete_log', log_id=0) }}".replace('0', logId);
        showModal('deleteModal');
    }
    
    // 给所有删除按钮添加事件监听
    document.querySelectorAll('.delete-icon').forEach(btn => {
        btn.addEventListener('click', function() {
            const logId = this.getAttribute('data-log-id');
            confirmDelete(logId);
        });
    });
    
    // 确认清除日志
    function confirmClearLogs() {
        showModal('clearLogsModal');
    }
    
    // 提交清除日志表单
    function submitClearLogs() {
        document.getElementById('clear-logs-form').submit();
    }
    
    // 关闭按钮
    document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', closeModal);
    });
    
    // 点击模态框背景关闭
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(event) {
            if (event.target === this) {
                closeModal();
            }
        });
    });
</script>
{% endblock %} 