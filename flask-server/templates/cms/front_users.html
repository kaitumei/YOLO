{% extends "common/cms_base.html" %}

{% block title %}【HorizonSafe】---前台用户管理{% endblock %}
{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='cms/css/front_users.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='cms/css/add_staff.css') }}">
{% endblock %}
{% block content %}
    <!-- 搜索框部分 -->
    <div class="search-box">
        <input type="text"
               class="search-input"
               placeholder="输入用户名、邮箱或手机号..."
               aria-label="搜索用户"
               value="{{ search }}">
        <button class="search-button" onclick="handleSearch()" title="搜索用户">
            <svg class="search-icon" viewBox="0 0 24 24">
                <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.7.7l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.494 4.494 0 0 1 9.5 14z"/>
            </svg>
        </button>
    </div>

    <div class="table-responsive">
        <table class="user-table" aria-describedby="用户列表">
            <thead>
                <tr>
                    <th scope="col">联系方式</th>
                    <th scope="col">用户名</th>
                    <th scope="col">邮箱</th>
                    <th scope="col">角色</th>
                    <th scope="col">状态</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td data-label="联系方式">{% if user.phone %}{{ user.phone }}{% else %}无{% endif %}</td>
                    <td data-label="用户名">{{ user.username }}</td>
                    <td data-label="邮箱">{{ user.email }}</td>
                    <td data-label="角色">
                        <span class="role-badge">{{ user.role.name if user.role else '无角色' }}</span>
                    </td>
                    <td data-label="状态">
                        {% if user.is_active %}
                            <button class="status-button button-disabled active-btn" data-active="1" data-user-id="{{ user.id }}">禁用</button>
                        {% else %}
                            <button class="status-button button-enabled active-btn" data-active="0" data-user-id="{{ user.id }}">启用</button>
                        {% endif %}
                    </td>
                    <td data-label="操作" class="action-cell">
                        <button class="icon-button edit-permission-btn" 
                                aria-label="编辑权限" 
                                data-user-id="{{ user.id }}"
                                data-username="{{ user.username }}"
                                data-email="{{ user.email }}"
                                data-phone="{{ user.phone }}"
                                data-role="{{ user.role.name if user.role else '无角色' }}">
                            <svg viewBox="0 0 24 24" width="18" height="18">
                                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                            </svg>
                            <span class="tooltip">编辑权限</span>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 分页导航 -->
    <nav class="pagination-wrapper" aria-label="分页导航">
        <div class="pagination">
            <div class="page-item disabled">
                <span class="page-link">共 {{ pagination.pages }} 页</span>
            </div>
            <div class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('cms.users_list', page=pagination.prev_num, search=search) }}">
                    &laquo; 上一页
                </a>
            </div>
            {% for p in pagination.iter_pages() %}
                {% if p %}
                    <div class="page-item {% if p == pagination.page %}active{% endif %}">
                        <a class="page-link"
                           href="{{ url_for('cms.users_list', page=p, search=search) }}">{{ p }}</a>
                    </div>
                {% else %}
                    <div class="page-item disabled"><span class="page-link">...</span></div>
                {% endif %}
            {% endfor %}
            <div class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('cms.users_list', page=pagination.next_num, search=search) }}">
                    下一页 &raquo;
                </a>
            </div>
        </div>
    </nav>

    <!-- 权限编辑模态框 -->
    <div class="modal fade" id="editPermissionsModal" tabindex="-1" aria-labelledby="editPermissionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="editPermissionsModalLabel">
                        <i class="fas fa-user-cog me-2"></i>编辑用户权限
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPermissionsForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" id="editUserId" name="user_id">
                        
                        <div class="mb-4">
                            <label for="editRole" class="form-label fw-bold">
                                <i class="fas fa-user-tag me-2"></i>用户角色
                            </label>
                            <select class="form-select form-select-lg" id="editRole" name="role_id">
                                {% for role in all_roles %}
                                    {% if role.name != '超级管理员' %}
                                        <option value="{{ role.id }}">{{ role.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <div class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>选择用户的新角色
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-key me-2"></i>当前权限
                            </label>
                            <div id="currentPermissions" class="permissions-list border rounded p-3 bg-light">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>加载中...
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">
                        <i class="fas fa-times me-2"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary" id="savePermissionsBtn">
                        <i class="fas fa-save me-2"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // front_users.js
        function handleSearch() {
            const searchInput = document.querySelector('.search-input');
            const searchTerm = searchInput.value.trim();
            const url = new URL(window.location.href);

            url.searchParams.set('search', searchTerm);
            url.searchParams.set('page', 1);

            window.location.href = url.toString();
        }

        document.querySelector('.search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        document.querySelector('.search-button').addEventListener('click', handleSearch);
        
        document.querySelectorAll('.active-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const isActive = this.dataset.active === '1' ? 0 : 1;
                const searchParams = new URLSearchParams(window.location.search);

                fetch(`/cms/front/users/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                    },
                    body: `is_active=${isActive}&${searchParams.toString()}`
                })
                .then(response => response.json())
                .then(data => {
                    if(data.code === 200){
                        window.location.reload();
                    }
                });
            });
        });

        const modal = new bootstrap.Modal(document.getElementById('editPermissionsModal'));
        const editPermissionsForm = document.getElementById("editPermissionsForm");
        const editUserIdInput = document.getElementById("editUserId");
        const editRoleSelect = document.getElementById("editRole");
        const currentPermissionsList = document.getElementById("currentPermissions");
        const savePermissionsBtn = document.getElementById("savePermissionsBtn");
        const cancelBtn = document.getElementById("cancelBtn");

        document.querySelectorAll('.edit-permission-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const role = this.dataset.role;
                
                editUserIdInput.value = userId;
                
                const roleOption = Array.from(editRoleSelect.options).find(option => option.text === role);
                if (roleOption) {
                    editRoleSelect.value = roleOption.value;
                }
                
                loadUserPermissions(userId);
                modal.show();
            });
        });

        function closeModal() {
            modal.hide();
            editPermissionsForm.reset();
            currentPermissionsList.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>加载中...</div>';
        }

        cancelBtn.addEventListener('click', closeModal);

        savePermissionsBtn.addEventListener('click', function(event) {
            event.preventDefault();
            
            const userId = editUserIdInput.value;
            const roleId = editRoleSelect.value;
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            
            if (!roleId) {
                showError('请选择用户角色');
                return;
            }
            
            savePermissionsBtn.classList.add('loading');
            savePermissionsBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('role_id', roleId);
            formData.append('csrf_token', csrfToken);
            
            fetch(`/cms/front/users/${userId}/update-role`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('更新失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    closeModal();
                    window.location.reload();
                } else {
                    showError(data.message || '更新失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('更新失败，请稍后重试');
            })
            .finally(() => {
                savePermissionsBtn.classList.remove('loading');
                savePermissionsBtn.disabled = false;
            });
        });

        function loadUserPermissions(userId) {
            currentPermissionsList.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>加载中...</div>';
            
            fetch(`/cms/user/${userId}/permissions`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取权限失败');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.data && data.data.role_id) {
                        editRoleSelect.value = data.data.role_id;
                    }
                    
                    if (data.data && data.data.permissions) {
                        updatePermissionsList(data.data.permissions);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    currentPermissionsList.innerHTML = '<div class="text-center text-danger"><i class="fas fa-exclamation-circle me-2"></i>获取权限失败，请重试</div>';
                });
        }

        function updatePermissionsList(permissions) {
            if (!permissions || permissions.length === 0) {
                currentPermissionsList.innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>该用户暂无权限</div>';
                return;
            }
            
            const html = permissions.map(permission => `
                <div class="permission-item">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="permission-name">${permission.name}</span>
                        <span class="permission-desc">${permission.description || '无描述'}</span>
                    </div>
                </div>
            `).join('');
            
            currentPermissionsList.innerHTML = html;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${message}`;
            
            const modalBody = document.querySelector('.modal-body');
            modalBody.insertBefore(errorDiv, modalBody.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }
    </script>
{% endblock %}