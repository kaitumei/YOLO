{% extends "common/cms_base.html" %}

{% block title %}【界安】---车辆预约审批{% endblock %}
{% block css %}
    <style>
        .appointment-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .appointment-table th,
        .appointment-table td {
            padding: 12px 15px;
            text-align: left;
        }
        
        .appointment-table thead {
            background-color: #3f51b5;
            color: white;
            font-weight: bold;
        }
        
        .appointment-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .appointment-table tbody tr:hover {
            background-color: #e9ecef;
        }
        
        .filter-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .filter-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .filter-form .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-form input, 
        .filter-form select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            width: 100%;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .search-btn {
            background-color: #3f51b5;
            color: white;
        }
        
        .reset-btn {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }
        
        .status-approved {
            background-color: #28a745;
            color: white;
        }
        
        .status-rejected {
            background-color: #dc3545;
            color: white;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .detail-btn {
            background-color: #17a2b8;
            color: white;
        }
        
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            flex: 1;
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            margin-right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .pending-icon {
            background-color: #ffc107;
        }
        
        .approved-icon {
            background-color: #28a745;
        }
        
        .rejected-icon {
            background-color: #dc3545;
        }
        
        .stat-content h3 {
            margin: 0;
            color: #495057;
        }
        
        .stat-content p {
            margin: 5px 0 0;
            font-weight: bold;
            font-size: 24px;
        }
        
        .batch-actions {
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .select-all {
            margin-right: 10px;
        }
        
        .batch-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .batch-approve {
            background-color: #28a745;
            color: white;
        }
        
        .batch-reject {
            background-color: #dc3545;
            color: white;
        }
        
        .batch-delete {
            background-color: #dc3545;
            color: white;
        }
        
        /* 确认对话框样式 */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050;
            display: none;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            max-width: 400px;
            width: 100%;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .modal-cancel {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
        }
        
        .modal-confirm {
            background-color: #dc3545;
            color: white;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- 统计信息 -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-icon pending-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <h3>待审核</h3>
                <p>{{ pending_count }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon approved-icon">
                <i class="fas fa-check"></i>
            </div>
            <div class="stat-content">
                <h3>已通过</h3>
                <p>{{ approved_count }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon rejected-icon">
                <i class="fas fa-times"></i>
            </div>
            <div class="stat-content">
                <h3>已拒绝</h3>
                <p>{{ rejected_count }}</p>
            </div>
        </div>
    </div>

    <!-- 筛选器 -->
    <div class="filter-container">
        <form class="filter-form" method="get" action="{{ url_for('cms.vehicle_appointments_list') }}">
            <div class="form-group">
                <label for="status">状态</label>
                <select id="status" name="status">
                    <option value="" {% if not status %}selected{% endif %}>全部</option>
                    <option value="待审核" {% if status == '待审核' %}selected{% endif %}>待审核</option>
                    <option value="已通过" {% if status == '已通过' %}selected{% endif %}>已通过</option>
                    <option value="已拒绝" {% if status == '已拒绝' %}selected{% endif %}>已拒绝</option>
                </select>
            </div>
            <div class="form-group">
                <label for="license_plate">车牌号码</label>
                <input type="text" id="license_plate" name="license_plate" value="{{ license_plate }}">
            </div>
            <div class="form-group">
                <label for="phone">联系电话</label>
                <input type="text" id="phone" name="phone" value="{{ phone }}">
            </div>
            <div class="form-group">
                <label for="start_date">开始日期</label>
                <input type="date" id="start_date" name="start_date" value="{{ start_date }}">
            </div>
            <div class="form-group">
                <label for="end_date">结束日期</label>
                <input type="date" id="end_date" name="end_date" value="{{ end_date }}">
            </div>
            <div class="filter-buttons">
                <button type="submit" class="filter-btn search-btn">
                    <i class="fas fa-search"></i> 搜索
                </button>
                <button type="button" class="filter-btn reset-btn" id="reset-filter">
                    <i class="fas fa-undo"></i> 重置
                </button>
            </div>
        </form>
    </div>

    <!-- 批量操作 -->
    <form id="batch-form" action="{{ url_for('cms.vehicle_appointment_batch_approve') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="batch-actions">
            <div class="form-check">
                <input class="form-check-input select-all" type="checkbox" id="select-all">
                <label class="form-check-label" for="select-all">全选</label>
            </div>
            <button type="button" class="batch-btn batch-approve" data-status="已通过">
                <i class="fas fa-check"></i> 批量通过
            </button>
            <button type="button" class="batch-btn batch-reject" data-status="已拒绝">
                <i class="fas fa-times"></i> 批量拒绝
            </button>
            <button type="button" class="batch-btn batch-delete" data-action="delete">
                <i class="fas fa-trash"></i> 批量删除
            </button>
            <input type="hidden" name="status" id="batch-status">
        </div>

        <!-- 数据表格 -->
        <div class="table-responsive">
            <table class="appointment-table" aria-describedby="车辆预约列表">
                <thead>
                    <tr>
                        <th scope="col" width="40">选择</th>
                        <th scope="col">车牌号码</th>
                        <th scope="col">车辆类型</th>
                        <th scope="col">姓名</th>
                        <th scope="col">联系电话</th>
                        <th scope="col">预约日期</th>
                        <th scope="col">预约时间</th>
                        <th scope="col">状态</th>
                        <th scope="col">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for appointment in appointments %}
                    <tr>
                        <td>
                            <input class="form-check-input appointment-checkbox" 
                                  type="checkbox" 
                                  name="appointment_ids" 
                                  value="{{ appointment.id }}"
                                  title="选择此预约记录"
                                  {% if appointment.status != '待审核' %}disabled{% endif %}>
                        </td>
                        <td data-label="车牌号码">{{ appointment.license_plate }}</td>
                        <td data-label="车辆类型">{{ appointment.vehicle_type }}</td>
                        <td data-label="姓名">{{ appointment.name }}</td>
                        <td data-label="联系电话">{{ appointment.phone }}</td>
                        <td data-label="预约日期">{{ appointment.appointment_date.strftime('%Y-%m-%d') }}</td>
                        <td data-label="预约时间">{{ appointment.appointment_time.strftime('%H:%M') }}</td>
                        <td data-label="状态">
                            <span class="status-badge {% if appointment.status == '待审核' %}status-pending{% elif appointment.status == '已通过' %}status-approved{% else %}status-rejected{% endif %}">
                                {{ appointment.status }}
                            </span>
                        </td>
                        <td data-label="操作">
                            <a href="{{ url_for('cms.vehicle_appointment_detail', appointment_id=appointment.id) }}" class="action-btn detail-btn">
                                <i class="fas fa-eye"></i> 详情
                            </a>
                            <button type="button" class="action-btn delete-btn" data-id="{{ appointment.id }}" data-license="{{ appointment.license_plate }}">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

    <!-- 分页导航 -->
    <nav class="pagination-wrapper" aria-label="分页导航">
        <div class="pagination">
            <div class="page-item disabled">
                <span class="page-link">共 {{ pagination.pages }} 页</span>
            </div>
            <div class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('cms.vehicle_appointments_list', page=pagination.prev_num, status=status, license_plate=license_plate, phone=phone, start_date=start_date, end_date=end_date) }}">
                    &laquo; 上一页
                </a>
            </div>
            {% for p in pagination.iter_pages() %}
                {% if p %}
                    <div class="page-item {% if p == pagination.page %}active{% endif %}">
                        <a class="page-link"
                           href="{{ url_for('cms.vehicle_appointments_list', page=p, status=status, license_plate=license_plate, phone=phone, start_date=start_date, end_date=end_date) }}">{{ p }}</a>
                    </div>
                {% else %}
                    <div class="page-item disabled"><span class="page-link">...</span></div>
                {% endif %}
            {% endfor %}
            <div class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('cms.vehicle_appointments_list', page=pagination.next_num, status=status, license_plate=license_plate, phone=phone, start_date=start_date, end_date=end_date) }}">
                    下一页 &raquo;
                </a>
            </div>
        </div>
    </nav>
    
    <!-- 删除确认对话框 -->
    <div class="modal-backdrop" id="deleteConfirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">确认删除</h3>
                <button type="button" class="modal-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                确定要删除此预约信息吗？此操作不可恢复。
                <p class="mt-2"><strong>车牌号码: </strong><span id="deleteLicensePlate"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-cancel" data-dismiss="modal">取消</button>
                <form id="deleteForm" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="modal-btn modal-confirm">确认删除</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 批量删除确认对话框 -->
    <div class="modal-backdrop" id="batchDeleteConfirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">确认批量删除</h3>
                <button type="button" class="modal-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>确定要删除选中的预约信息吗？此操作不可恢复。</p>
                <p class="mt-2"><strong>选中记录数: </strong><span id="selectedCount">0</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-cancel" data-dismiss="modal">取消</button>
                <button type="button" class="modal-btn modal-confirm" id="confirmBatchDelete">确认删除</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script>
        // 重置筛选器
        document.getElementById('reset-filter').addEventListener('click', function() {
            window.location.href = "{{ url_for('cms.vehicle_appointments_list') }}";
        });
        
        // 全选/取消全选
        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.appointment-checkbox:not(:disabled)');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
        
        // 批量操作
        document.querySelectorAll('.batch-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const checkedBoxes = document.querySelectorAll('.appointment-checkbox:checked');
                
                if (checkedBoxes.length === 0) {
                    alert('请至少选择一条预约记录！');
                    return;
                }
                
                // 处理批量删除
                if (this.dataset.action === 'delete') {
                    document.getElementById('selectedCount').textContent = checkedBoxes.length;
                    showModal('batchDeleteConfirmModal');
                    return;
                }
                
                // 处理批量审批
                const status = this.dataset.status;
                if (confirm(`确定要将选中的 ${checkedBoxes.length} 条预约记录标记为"${status}"吗？`)) {
                    document.getElementById('batch-status').value = status;
                    document.getElementById('batch-form').submit();
                }
            });
        });
        
        // 监听单个复选框变化，更新全选状态
        document.querySelectorAll('.appointment-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const allCheckboxes = document.querySelectorAll('.appointment-checkbox:not(:disabled)');
                const checkedCheckboxes = document.querySelectorAll('.appointment-checkbox:checked');
                
                document.getElementById('select-all').checked = 
                    allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
            });
        });
        
        // 删除按钮点击事件
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const appointmentId = this.dataset.id;
                const licensePlate = this.dataset.license;
                
                // 设置确认对话框内容
                document.getElementById('deleteLicensePlate').textContent = licensePlate;
                document.getElementById('deleteForm').action = "{{ url_for('cms.vehicle_appointment_delete', appointment_id=0) }}".replace('0', appointmentId);
                
                // 显示确认对话框
                showModal('deleteConfirmModal');
            });
        });
        
        // 确认批量删除
        document.getElementById('confirmBatchDelete').addEventListener('click', function() {
            const form = document.getElementById('batch-form');
            form.action = "{{ url_for('cms.vehicle_appointment_batch_delete') }}";
            form.submit();
        });
        
        // 显示模态框
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        // 关闭模态框
        document.querySelectorAll('[data-dismiss="modal"]').forEach(element => {
            element.addEventListener('click', function() {
                this.closest('.modal-backdrop').style.display = 'none';
            });
        });
    </script>
{% endblock %} 