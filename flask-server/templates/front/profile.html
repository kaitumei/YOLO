{% extends 'common/front_base.html' %}

{% block title %}{{ user.username }}---个人中心{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='front/css/profile.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}
{% block content %}
<div class="profile-container">
    <!-- 头像和个人信息 -->
    <div class="username-container" id="usernameContainer">
        <div class="avatar" id="avatarContainer">
            {% if user.avatar %}
                <img src="{{ user.avatar }}" alt="头像" id="avatar-preview" onerror="this.onerror=null; this.src='{{ g.avatars.robohash(user.id) }}'; console.log('头像加载失败，使用默认头像');">
            {% else %}
                <img src="{{ g.avatars.robohash(user.id) }}" alt="头像" id="avatar-preview">
            {% endif %}
            
            {% if is_mine %}
            <!-- 添加一个覆盖层，显示更换头像提示 -->
            <div class="avatar-overlay" id="avatarOverlay">
                <i class="fas fa-camera"></i>
                <span>更换头像</span>
            </div>
            {% endif %}
        </div>
        
        <!-- 上传状态提示 -->
        <div id="upload-status" class="upload-status hidden"></div>
        
        {% if is_mine %}
        <span class="username-view" onclick="enterEditMode()">{{ user.username }}</span>
        <div class="edit-wrapper">
            <input type="text"
                    class="username-edit"
                    name="username"
                    id="username-input"
                    value="{{ user.username }}"
                    onblur="saveUsername()"
                    onkeydown="handleKeyEvents(event)">
        </div>
        {% else %}
        <span class="username-view">{{ user.username }}</span>
        {% endif %}
        
        <p class="user-quote">
            <i class="fas fa-quote-left fa-xs"></i> 
            {% if user.signature %}
                {{ user.signature }}
            {% else %}
                欢迎来到个人中心
            {% endif %} 
            <i class="fas fa-quote-right fa-xs"></i>
        </p>
    </div>
    
    <!-- 头像上传模态框 -->
    {% if is_mine %}
    <div class="avatar-modal" id="avatarModal">
        <div class="avatar-modal-content">
            <div class="avatar-modal-header">
                <h3>更换头像</h3>
                <button class="avatar-modal-close" id="closeAvatarModal">&times;</button>
            </div>
            <div class="avatar-preview-container">
                <img id="avatarModalPreview" src="{{ user.avatar if user.avatar else g.avatars.robohash(user.id) }}" alt="头像预览">
            </div>
            <div class="avatar-upload-options">
                <label for="avatar-upload" class="avatar-upload-btn avatar-upload-primary">
                    <i class="fas fa-upload"></i> 选择图片
                </label>
                <button type="button" id="confirmAvatar" class="avatar-upload-btn avatar-upload-primary hidden">
                    <i class="fas fa-check"></i> 确认更换
                </button>
                <button type="button" class="avatar-upload-btn avatar-upload-cancel" id="cancelAvatarUpload">
                    取消
                </button>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 统计数据 -->
    <div class="stats-container">
        <div class="stat-card">
            <i class="fas fa-calendar-alt"></i>
            <div class="stat-number">{{ (now.date() - user.join_time.date()).days if user.join_time else 0 }}</div>
            <div class="stat-label">已加入天数</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-clock"></i>
            <div class="stat-number">{{ user.last_login.strftime('%m-%d %H:%M') if user.last_login else '未登录' }}</div>
            <div class="stat-label">上次登录</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-user-shield"></i>
            <div class="stat-number">{{ user.role.name if user.role else '普通用户' }}</div>
            <div class="stat-label">用户角色</div>
        </div>
    </div>
    
    <!-- 选项卡导航 -->
    <div class="profile-tabs">
        <div class="profile-tab active" onclick="switchTab('profile-info')">
            <i class="fas fa-user"></i> 个人资料
        </div>
        <div class="profile-tab" onclick="switchTab('security-settings')">
            <i class="fas fa-shield-alt"></i> 安全设置
        </div>
        <div class="profile-tab" onclick="switchTab('activity-log')">
            <i class="fas fa-history"></i> 最近活动
        </div>
    </div>
    
    <!-- 个人资料部分 -->
    <div id="profile-info" class="profile-section active">
        <form action="{{ url_for('front.edit_profile') }}" method="post" enctype="multipart/form-data" id="profile-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="username" id="username-hidden" value="{{ user.username }}">
            
            <!-- 隐藏的文件上传元素 -->
            {% if is_mine %}
                <input type="file" class="hidden-input" id="avatar-upload" name="avatar" accept="image/*">
            {% endif %}
            
            <div class="personage">
                <h3 class="personage-title"><i class="fas fa-user-circle"></i> 基本信息</h3>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-envelope"></i>
                        <span>邮箱</span>
                    </div>
                    <div class="info-content">
                        <p>{{ user.email or '未设置' }}</p>
                        {% if user.email %}
                            <span class="verified-badge"><i class="fas fa-check-circle"></i> 已验证</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-mobile-alt"></i>
                        <span>手机号</span>
                    </div>
                    <div class="info-content">
                        <p>{{ user.phone or '未绑定' }}</p>
                        {% if user.phone and user.phone_verified %}
                            <span class="verified-badge"><i class="fas fa-check-circle"></i> 已验证</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-calendar-alt"></i>
                        <span>注册时间</span>
                    </div>
                    <div class="info-content">
                        <p>{{ user.join_time.strftime('%Y-%m-%d %H:%M') if user.join_time else '未知' }}</p>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-pen"></i>
                        <span>个性签名</span>
                    </div>
                    <div class="info-content">
                        {% if is_mine %}
                        <div class="signature-wrapper">
                            <textarea name="signature" id="signature-input" maxlength="100" placeholder="请输入您的个性签名，展示自己的风采吧~">{{ user.signature }}</textarea>
                            <div class="signature-counter">
                                <span id="signature-count">0</span>/100
                            </div>
                        </div>
                        {% else %}
                        <p class="signature-display">{{ user.signature or "这个人很懒，还没有设置签名~" }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {% if is_mine %}
            <div class="skills">
                <button type="submit" class="submit-button" id="save-profile-btn">
                    <i class="fas fa-save"></i> 保存资料
                </button>
            </div>
            {% endif %}
        </form>
    </div>
    
    <!-- 安全设置部分 -->
    <div id="security-settings" class="profile-section">
        <div class="personage">
            <h3 class="personage-title"><i class="fas fa-shield-alt"></i> 账号安全</h3>
            
            <div class="security-item">
                <div class="security-info">
                    <div class="security-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="security-details">
                        <h4>登录密码</h4>
                        <p>用于保护账号安全，建议定期更换</p>
                    </div>
                </div>
                <div class="security-action">
                    <a href="{{ url_for('front.change_password') }}"><i class="fas fa-edit"></i> 修改</a>
                </div>
            </div>
            
            <div class="security-item">
                <div class="security-info">
                    <div class="security-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="security-details">
                        <h4>邮箱验证</h4>
                        <p>{% if user.email %}已绑定邮箱: {{ user.email }}{% else %}未绑定邮箱{% endif %}</p>
                    </div>
                </div>
                <div class="security-action">
                    {% if user.email %}
                        <a href="#" onclick="alert('功能开发中')"><i class="fas fa-exchange-alt"></i> 更换</a>
                    {% else %}
                        <a href="#" onclick="alert('功能开发中')"><i class="fas fa-plus"></i> 绑定</a>
                    {% endif %}
                </div>
            </div>
            
            <div class="security-item">
                <div class="security-info">
                    <div class="security-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="security-details">
                        <h4>手机验证</h4>
                        <p>{% if user.phone %}已绑定手机: {{ user.phone|replace(user.phone[3:7], '****') }}{% else %}未绑定手机{% endif %}</p>
                    </div>
                </div>
                <div class="security-action">
                    {% if user.phone %}
                        <a href="#" onclick="alert('功能开发中')"><i class="fas fa-exchange-alt"></i> 更换</a>
                    {% else %}
                        <a href="#" onclick="alert('功能开发中')"><i class="fas fa-plus"></i> 绑定</a>
                    {% endif %}
                </div>
            </div>
            
            <div class="security-item">
                <div class="security-info">
                    <div class="security-icon">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <div class="security-details">
                        <h4>账号安全退出</h4>
                        <p>结束在所有设备上的登录会话</p>
                    </div>
                </div>
                <div class="security-action">
                    <a href="{{ url_for('front.logout') }}" class="logout-btn"><i class="fas fa-sign-out-alt"></i> 安全退出</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 活动记录部分 -->
    <div id="activity-log" class="profile-section">
        <div class="personage">
            <h3 class="personage-title"><i class="fas fa-history"></i> 活动记录</h3>
            
            <div class="activity-card">
                <div class="activity-icon">
                    <i class="fas fa-sign-in-alt"></i>
                </div>
                <div class="activity-details">
                    <h4>账号登录</h4>
                    <p>最近一次登录于 {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else '未知' }}</p>
                    <div class="activity-time">
                        <i class="fas fa-clock"></i> {{ user.last_login.strftime('%Y-%m-%d %H:%M:%S') if user.last_login else '未知' }}
                    </div>
                </div>
            </div>
            
            <div class="activity-card">
                <div class="activity-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div class="activity-details">
                    <h4>账号注册</h4>
                    <p>您的账号创建于 {{ user.join_time.strftime('%Y-%m-%d') if user.join_time else '未知' }}</p>
                    <div class="activity-time">
                        <i class="fas fa-clock"></i> {{ user.join_time.strftime('%Y-%m-%d %H:%M:%S') if user.join_time else '未知' }}
                    </div>
                </div>
            </div>
            
            <!-- 可以添加更多活动记录 -->
            <div class="no-more-activities">
                <p><i class="fas fa-info-circle"></i> 没有更多活动记录</p>
            </div>
        </div>
    </div>
</div>

<script>
    // 当前用户名
    let originalUsername = '{{ user.username }}';
    let isEditing = false;
    
    // 设置当前日期到模板变量
    const now = new Date();
    
    // 头像上传相关变量
    let fileSelected = false;
    let currentFile = null;
    
    // 显示上传状态消息
    function showUploadStatus(message, type) {
        const statusEl = document.getElementById('upload-status');
        if (statusEl) {
            statusEl.textContent = message;
            statusEl.className = 'upload-status';
            if (type) {
                statusEl.classList.add(type);
            }
            statusEl.style.display = 'block';
            
            // 5秒后自动隐藏
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
    }
    
    // 检查URL参数是否有错误信息
    function checkForMessages() {
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        const success = urlParams.get('success');
        
        if (error) {
            showUploadStatus(decodeURIComponent(error), 'error');
        } else if (success) {
            showUploadStatus(decodeURIComponent(success), 'success');
        }
    }
    
    // 页面加载时检查消息
    document.addEventListener('DOMContentLoaded', function() {
        checkForMessages();
        
        // 初始化头像模态框
        initAvatarModal();
    });
    
    // 初始化头像上传模态框
    function initAvatarModal() {
        const avatarContainer = document.getElementById('avatarContainer');
        const avatarOverlay = document.getElementById('avatarOverlay');
        const avatarModal = document.getElementById('avatarModal');
        const closeModalBtn = document.getElementById('closeAvatarModal');
        const cancelUploadBtn = document.getElementById('cancelAvatarUpload');
        const fileInput = document.getElementById('avatar-upload');
        const confirmBtn = document.getElementById('confirmAvatar');
        const avatarPreview = document.getElementById('avatar-preview');
        const modalPreview = document.getElementById('avatarModalPreview');
        
        if (!avatarContainer || !avatarModal) return;
        
        // 点击头像区域打开模态框
        if (avatarOverlay) {
            avatarOverlay.addEventListener('click', function(e) {
                e.preventDefault();
                // 显示模态框
                avatarModal.style.display = 'flex';
                // 设置模态框中的预览图像
                modalPreview.src = avatarPreview.src;
                // 重置文件选择状态
                fileSelected = false;
                confirmBtn.style.display = 'none';
            });
        }
        
        // 关闭模态框
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function() {
                avatarModal.style.display = 'none';
                // 如果没有确认上传，清空文件输入
                if (!fileSelected) {
                    fileInput.value = '';
                }
            });
        }
        
        // 取消按钮
        if (cancelUploadBtn) {
            cancelUploadBtn.addEventListener('click', function() {
                avatarModal.style.display = 'none';
                // 如果没有确认上传，清空文件输入
                if (!fileSelected) {
                    fileInput.value = '';
                }
            });
        }
        
        // 文件选择处理
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // 验证文件类型
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        alert('请选择有效的图片文件（JPEG, PNG, GIF, WEBP）');
                        // 清空文件选择
                        this.value = '';
                        return;
                    }
                    
                    // 验证文件大小 (最大2MB)
                    const maxSize = 2 * 1024 * 1024; // 2MB
                    if (file.size > maxSize) {
                        alert('图片文件过大，请选择小于2MB的文件');
                        // 清空文件选择
                        this.value = '';
                        return;
                    }
                    
                    // 保存当前选择的文件
                    currentFile = file;
                    fileSelected = true;
                    
                    // 创建预览
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        modalPreview.src = e.target.result;
                        // 显示确认按钮
                        confirmBtn.style.display = 'inline-block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // 确认上传处理
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function() {
                if (!fileSelected || !currentFile) {
                    alert('请先选择一个图片文件');
                    return;
                }
                
                // 关闭模态框
                avatarModal.style.display = 'none';
                
                // 显示上传中提示
                showUploadStatus('正在上传头像...', 'warning');
                
                // 更新主预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    avatarPreview.src = e.target.result;
                };
                reader.readAsDataURL(currentFile);
                
                // 提交表单
                submitAvatarForm();
            });
        }
    }
    
    // 提交头像表单
    function submitAvatarForm() {
        // 创建表单数据
        const formData = new FormData(document.getElementById('profile-form'));
        
        // 添加时间戳防止缓存
        formData.append('timestamp', new Date().getTime());
        
        // 显示上传进度
        const confirmBtn = document.getElementById('confirmAvatar');
        if (confirmBtn) {
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上传中...';
            confirmBtn.disabled = true;
        }
        
        // 使用fetch API上传
        fetch('{{ url_for("front.edit_profile") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.redirected) {
                // 如果重定向，跟随重定向
                window.location.href = response.url;
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.success) {
                showUploadStatus('头像更新成功!', 'success');
            } else if (data && data.error) {
                showUploadStatus(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('上传出错:', error);
            showUploadStatus('上传失败，请稍后重试', 'error');
        })
        .finally(() => {
            if (confirmBtn) {
                confirmBtn.innerHTML = '<i class="fas fa-check"></i> 确认更换';
                confirmBtn.disabled = false;
            }
        });
    }
    
    // 切换选项卡功能
    function switchTab(tabId) {
        // 移除所有选项卡的活动状态
        document.querySelectorAll('.profile-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // 隐藏所有内容区域
        document.querySelectorAll('.profile-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // 激活点击的选项卡
        event.currentTarget.classList.add('active');
        
        // 显示对应的内容区域
        document.getElementById(tabId).classList.add('active');
    }

    // 进入编辑模式
    function enterEditMode() {
        const container = document.getElementById('usernameContainer');
        const input = container.querySelector('.username-edit');

        container.classList.add('editing');
        input.value = originalUsername;
        input.focus();
        input.select();
        isEditing = true;

        // 添加全局点击监听
        document.addEventListener('click', checkClickOutside);
    }

    // 退出编辑模式
    function exitEditMode(save = false) {
        const container = document.getElementById('usernameContainer');
        const view = container.querySelector('.username-view');
        const input = container.querySelector('.username-edit');

        if (!save) {
            input.value = originalUsername; // 恢复原始值
        } else {
            originalUsername = input.value; // 更新缓存值
            view.textContent = input.value;  // 更新显示值
        }

        container.classList.remove('editing');
        isEditing = false;
        document.removeEventListener('click', checkClickOutside);
    }
    
    // 保存用户名
    function saveUsername() {
        const input = document.getElementById('username-input');
        const newUsername = input.value.trim();
        
        if (newUsername && newUsername !== originalUsername) {
            // 更新表单中的用户名
            document.getElementById('username-hidden').value = newUsername;
            
            // 更新显示
            const view = document.querySelector('.username-view');
            view.textContent = newUsername;
            originalUsername = newUsername;
        }
        
        // 关闭编辑模式
        exitEditMode(true);
    }

    // 检查是否点击外部
    function checkClickOutside(event) {
        const container = document.getElementById('usernameContainer');
        if (!container.contains(event.target)) {
            saveUsername();
        }
    }

    // 处理键盘事件
    function handleKeyEvents(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            saveUsername(); // 保存用户名
        } else if (event.key === 'Escape') {
            exitEditMode(false); // 取消修改
        }
    }

    // 签名框字数统计功能
    if (document.getElementById('signature-input')) {
        const signatureInput = document.getElementById('signature-input');
        const signatureCount = document.getElementById('signature-count');
        
        // 初始化计数(处理初始值)
        const initialText = signatureInput.value;
        signatureCount.textContent = initialText && initialText !== 'None' ? initialText.length : 0;
        
        // 如果值是"None"，清空它
        if (initialText === 'None') {
            signatureInput.value = '';
        }
        
        // 监听输入事件
        signatureInput.addEventListener('input', function() {
            signatureCount.textContent = this.value.length;
            
            // 当接近最大字数时添加警告样式
            if (this.value.length > 80) {
                signatureCount.classList.add('warning');
            } else {
                signatureCount.classList.remove('warning');
            }
        });
        
        // 自适应文本框高度
        signatureInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // 初始化高度
        setTimeout(function() {
            signatureInput.style.height = 'auto';
            signatureInput.style.height = (signatureInput.scrollHeight) + 'px';
        }, 0);
    }
</script>
{% endblock %}