{% extends 'common/front_base.html' %}

{% block title %}【界安】 - 密码重置{% endblock %}

{% block css %}
<style>
    /* 覆盖基础模板中的内容区域样式，使密码重置页面全屏显示 */
    .content {
        margin-left: 0 !important;
        padding: 0 !important;
    }
    
    /* 在密码重置页面上隐藏侧边栏 */
    .sidebar, .sidebar-overlay, .mobile-nav-trigger {
        display: none !important;
    }

    :root {
        --primary: #2c8cff;
        --error: #dc3545;
        --success: #28a745;
        --background: #f8f9fa;
    }

    body {
        background: var(--background);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: 'Segoe UI', system-ui;
    }

    .reset-container {
        background: white;
        width: min(90%, 420px);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 2rem;
    }

    .lock-icon {
        width: 40px;
        height: 40px;
        fill: var(--primary);
    }

    h1 {
        color: #2c3e50;
        font-size: 1.75rem;
        margin: 0;
    }

    .form-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .input-wrapper {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        transition: border-color 0.3s ease;
        display: flex;
        align-items: center;
        padding-right: 40px;
    }

    .input-wrapper:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(44,140,255,0.15);
    }

    input {
        width: 100%;
        padding: 12px;
        border: none;
        background: transparent;
        font-size: 1rem;
        outline: none;
    }

    .toggle-password {
        position: absolute;
        right: 12px;
        cursor: pointer;
        width: 24px;
        height: 24px;
        transition: opacity 0.3s;
    }

    .toggle-password:hover {
        opacity: 0.8;
    }

    .strength-meter {
        height: 4px;
        border-radius: 2px;
        margin-top: 8px;
        background: #ddd;
        overflow: hidden;
    }

    .strength-fill {
        width: 0%;
        height: 100%;
        transition: width 0.3s ease, background 0.3s;
    }

    .error-message {
        color: var(--error);
        font-size: 0.875rem;
        height: 20px;
        margin-top: 4px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .show-error {
        opacity: 1;
    }

    .submit-btn {
        width: 100%;
        padding: 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(44,140,255,0.3);
    }

    .submit-btn:disabled {
        background: #adb5bd;
        cursor: not-allowed;
    }
    
    .svg-definitions {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="reset-container">
    <div class="header">
        <svg class="lock-icon" viewBox="0 0 24 24">
            <path d="M12 2C9.243 2 7 4.243 7 7v3H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1V7c0-2.757-2.243-5-5-5zm6 12v6H6v-6h12zm-6-1a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM9 7c0-1.654 1.346-3 3-3s3 1.346 3 3v3H9V7z"/>
        </svg>
        <h1>重置密码</h1>
    </div>

    <form id="passwordForm">
        <!-- 新密码输入 -->
        <div class="form-group">
            <label for="newPassword">新密码</label>
            <div class="input-wrapper">
                <input type="password" id="newPassword" required
                       autocomplete="new-password" minlength="8">
                <svg class="toggle-password" data-target="newPassword">
                    <use href="#eye-icon" />
                </svg>
            </div>
            <div class="strength-meter">
                <div class="strength-fill"></div>
            </div>
            <div class="error-message">需包含大小写字母、数字及特殊字符</div>
        </div>

        <!-- 确认密码 -->
        <div class="form-group">
            <label for="confirmPassword">确认密码</label>
            <div class="input-wrapper">
                <input type="password" id="confirmPassword" required
                       autocomplete="new-password">
                <svg class="toggle-password" data-target="confirmPassword">
                    <use href="#eye-icon" />
                </svg>
            </div>
            <div class="error-message">两次输入的密码不一致</div>
        </div>

        <button type="submit" class="submit-btn" disabled>
            提交新密码
        </button>
    </form>
</div>

<!-- SVG图标定义 -->
<svg class="svg-definitions">
    <symbol id="eye-icon" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12 6a9.77 9.77 0 0 1 8.82 5.5A9.77 9.77 0 0 1 12 17a9.77 9.77 0 0 1-8.82-5.5A9.77 9.77 0 0 1 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5a2.5 2.5 0 0 1 0 5 2.5 2.5 0 0 1 0-5m0-2a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9z"/>
    </symbol>
</svg>
{% endblock %}

{% block js %}
<script>
    // 密码可见性切换
    const toggleButtons = document.querySelectorAll('.toggle-password');
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const passwordInput = document.getElementById(targetId);
            const eyeIcon = this.querySelector('use');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.setAttribute('href', '#eye-icon');
                this.style.opacity = '1';
            } else {
                passwordInput.type = 'password';
                eyeIcon.setAttribute('href', '#eye-icon');
                this.style.opacity = '0.6';
            }
        });
    });

    // 密码强度检测
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const strengthFill = document.querySelector('.strength-fill');
    const submitButton = document.querySelector('.submit-btn');
    
    function checkPasswordStrength(password) {
        let score = 0;
        
        // 长度检查
        if (password.length >= 8) score += 1;
        if (password.length >= 12) score += 1;
        
        // 包含数字
        if (/\d/.test(password)) score += 1;
        
        // 包含小写字母
        if (/[a-z]/.test(password)) score += 1;
        
        // 包含大写字母
        if (/[A-Z]/.test(password)) score += 1;
        
        // 包含特殊字符
        if (/[^a-zA-Z0-9]/.test(password)) score += 1;
        
        return {
            score: score,
            percent: Math.min(100, score * 16.7),
            color: score <= 2 ? '#dc3545' : score <= 4 ? '#ffc107' : '#28a745'
        };
    }
    
    newPassword.addEventListener('input', function() {
        const result = checkPasswordStrength(this.value);
        
        // 更新密码强度指示器
        strengthFill.style.width = `${result.percent}%`;
        strengthFill.style.background = result.color;
        
        // 显示或隐藏错误消息
        const errorMessage = this.parentElement.nextElementSibling.nextElementSibling;
        if (result.score < 3 && this.value.length > 0) {
            errorMessage.classList.add('show-error');
        } else {
            errorMessage.classList.remove('show-error');
        }
        
        // 检查表单有效性
        validateForm();
    });
    
    confirmPassword.addEventListener('input', function() {
        const errorMessage = this.parentElement.nextElementSibling;
        
        // 检查两次密码是否一致
        if (this.value && this.value !== newPassword.value) {
            errorMessage.classList.add('show-error');
        } else {
            errorMessage.classList.remove('show-error');
        }
        
        // 检查表单有效性
        validateForm();
    });
    
    function validateForm() {
        const newPasswordValue = newPassword.value;
        const confirmPasswordValue = confirmPassword.value;
        const passwordStrength = checkPasswordStrength(newPasswordValue);
        
        // 当所有条件满足时启用提交按钮
        if (
            newPasswordValue.length >= 8 &&
            passwordStrength.score >= 3 &&
            confirmPasswordValue === newPasswordValue &&
            confirmPasswordValue.length > 0
        ) {
            submitButton.disabled = false;
        } else {
            submitButton.disabled = true;
        }
    }
    
    // 表单提交处理
    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 在这里添加重置密码的AJAX请求
        // 例如:
        /*
        fetch('/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: 'YOUR_RESET_TOKEN', // 从URL获取
                password: newPassword.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/login?reset=success';
            } else {
                // 显示错误消息
            }
        });
        */
        
        // 模拟成功
        alert('密码重置成功！即将跳转到登录页面。');
        setTimeout(() => {
            window.location.href = '/login';
        }, 1000);
    });
</script>
{% endblock %}