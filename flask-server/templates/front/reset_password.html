{% extends 'common/front_base.html' %}

{% block title %}【HorizonSafe 界安】 - 密码重置{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='front/css/reset_password.css') }}">
{% endblock %}

{% block content %}
<div class="reset-container">
    <div class="header">
        <svg class="lock-icon" viewBox="0 0 24 24">
            <path d="M12 2C9.243 2 7 4.243 7 7v3H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1V7c0-2.757-2.243-5-5-5zm6 12v6H6v-6h12zm-6-1a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM9 7c0-1.654 1.346-3 3-3s3 1.346 3 3v3H9V7z"/>
        </svg>
        <h1>重置密码</h1>
    </div>

    <form id="passwordForm">
        <!-- 新密码输入 -->
        <div class="form-group">
            <label for="newPassword">新密码</label>
            <div class="input-wrapper">
                <input type="password" id="newPassword" required
                       autocomplete="new-password" minlength="8">
                <svg class="toggle-password" data-target="newPassword">
                    <use href="#eye-icon" />
                </svg>
            </div>
            <div class="strength-meter">
                <div class="strength-fill"></div>
            </div>
            <div class="error-message">需包含大小写字母、数字及特殊字符</div>
        </div>

        <!-- 确认密码 -->
        <div class="form-group">
            <label for="confirmPassword">确认密码</label>
            <div class="input-wrapper">
                <input type="password" id="confirmPassword" required
                       autocomplete="new-password">
                <svg class="toggle-password" data-target="confirmPassword">
                    <use href="#eye-icon" />
                </svg>
            </div>
            <div class="error-message">两次输入的密码不一致</div>
        </div>

        <button type="submit" class="submit-btn" disabled>
            提交新密码
        </button>
    </form>
</div>

<!-- SVG图标定义 -->
<svg class="svg-definitions">
    <symbol id="eye-icon" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12 6a9.77 9.77 0 0 1 8.82 5.5A9.77 9.77 0 0 1 12 17a9.77 9.77 0 0 1-8.82-5.5A9.77 9.77 0 0 1 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5a2.5 2.5 0 0 1 0 5 2.5 2.5 0 0 1 0-5m0-2a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9z"/>
    </symbol>
</svg>
{% endblock %}

{% block js %}
<script>
    // 密码可见性切换
    const toggleButtons = document.querySelectorAll('.toggle-password');
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const passwordInput = document.getElementById(targetId);
            const eyeIcon = this.querySelector('use');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.setAttribute('href', '#eye-icon');
                this.style.opacity = '1';
            } else {
                passwordInput.type = 'password';
                eyeIcon.setAttribute('href', '#eye-icon');
                this.style.opacity = '0.6';
            }
        });
    });

    // 密码强度检测
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const strengthFill = document.querySelector('.strength-fill');
    const submitButton = document.querySelector('.submit-btn');
    
    function checkPasswordStrength(password) {
        let score = 0;
        
        // 长度检查
        if (password.length >= 8) score += 1;
        if (password.length >= 12) score += 1;
        
        // 包含数字
        if (/\d/.test(password)) score += 1;
        
        // 包含小写字母
        if (/[a-z]/.test(password)) score += 1;
        
        // 包含大写字母
        if (/[A-Z]/.test(password)) score += 1;
        
        // 包含特殊字符
        if (/[^a-zA-Z0-9]/.test(password)) score += 1;
        
        return {
            score: score,
            percent: Math.min(100, score * 16.7),
            color: score <= 2 ? '#dc3545' : score <= 4 ? '#ffc107' : '#28a745'
        };
    }
    
    newPassword.addEventListener('input', function() {
        const result = checkPasswordStrength(this.value);
        
        // 更新密码强度指示器
        strengthFill.style.width = `${result.percent}%`;
        strengthFill.style.background = result.color;
        
        // 显示或隐藏错误消息
        const errorMessage = this.parentElement.nextElementSibling.nextElementSibling;
        if (result.score < 3 && this.value.length > 0) {
            errorMessage.classList.add('show-error');
        } else {
            errorMessage.classList.remove('show-error');
        }
        
        // 检查表单有效性
        validateForm();
    });
    
    confirmPassword.addEventListener('input', function() {
        const errorMessage = this.parentElement.nextElementSibling;
        
        // 检查两次密码是否一致
        if (this.value && this.value !== newPassword.value) {
            errorMessage.classList.add('show-error');
        } else {
            errorMessage.classList.remove('show-error');
        }
        
        // 检查表单有效性
        validateForm();
    });
    
    function validateForm() {
        const newPasswordValue = newPassword.value;
        const confirmPasswordValue = confirmPassword.value;
        const passwordStrength = checkPasswordStrength(newPasswordValue);
        
        // 当所有条件满足时启用提交按钮
        if (
            newPasswordValue.length >= 8 &&
            passwordStrength.score >= 3 &&
            confirmPasswordValue === newPasswordValue &&
            confirmPasswordValue.length > 0
        ) {
            submitButton.disabled = false;
        } else {
            submitButton.disabled = true;
        }
    }
    
    // 表单提交处理
    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 在这里添加重置密码的AJAX请求
        // 例如:
        /*
        fetch('/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: 'YOUR_RESET_TOKEN', // 从URL获取
                password: newPassword.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/login?reset=success';
            } else {
                // 显示错误消息
            }
        });
        */
        
        // 模拟成功
        alert('密码重置成功！即将跳转到登录页面。');
        setTimeout(() => {
            window.location.href = '/login';
        }, 1000);
    });
</script>
{% endblock %}