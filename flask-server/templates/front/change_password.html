{% extends 'common/front_base.html' %}

{% block title %}安全密码修改{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='front/css/change_password.css') }}">
{% endblock %}

{% block content %}
<div class="password-modify-container">
    <h2 class="security-title">
        <i class="bi bi-shield-lock"></i>
        修改密码
    </h2>
    <form method="POST" class="needs-validation" novalidate>
        {{ form.csrf_token() }}

        <!-- 旧密码组 -->
        <div class="mb-3 password-group">
            <label for="current-password" class="form-label">当前密码</label>
            <div class="input-icon">
                {{ form.old_password(
                    class="form-control",
                    id="current-password",
                    autocomplete="current-password",
                    placeholder="输入正在使用的密码",
                    required=true
                ) }}
                <i class="bi bi-key input-icon"></i>
            </div>
            <div class="invalid-feedback">请输入有效的当前密码</div>
        </div>

        <!-- 新密码组 -->
        <div class="mb-3 password-group">
            <label for="new-password" class="form-label">新密码</label>
            <div class="input-icon">
                {{ form.new_password(
                    class="form-control",
                    id="new-password",
                    autocomplete="new-password",
                    placeholder="8-20位字母/数字/符号组合",
                    pattern="^(?=.*\d)(?=.*[a-zA-Z]).{8,20}$",
                    required=true
                ) }}
                <i class="bi bi-lock input-icon"></i>
                <button type="button" class="btn btn-link password-toggle" aria-label="显示密码">
                    <i class="bi bi-eye"></i>
                </button>
            </div>
            <div class="invalid-feedback">需包含字母+数字，8-20位字符</div>
            <div class="password-strength mt-2"></div>
        </div>

        <!-- 确认密码组 -->
        <div class="mb-4 password-group">
            <label for="confirm-password" class="form-label">确认新密码</label>
            <div class="input-icon">
                {{ form.confirm_password(
                    class="form-control",
                    id="confirm-password",
                    placeholder="再次输入新密码",
                    required=true
                ) }}
                <i class="bi bi-lock-fill input-icon"></i>
            </div>
            <div class="invalid-feedback">两次输入密码不一致</div>
            <div class="password-match-feedback text-success mt-2"></div>
        </div>

        <button type="submit" class="btn btn-primary btn-security w-100">
            <i class="bi bi-check-circle me-2"></i>
            确认更新
        </button>
        <a href="{{  url_for('front.profile', user_id=g.user.id) }}" class="cancel">返回</a>

        <!-- 安全提示 -->
        <div class="security-tips mt-4">
            <i class="bi bi-info-circle me-2"></i>
            建议定期更换密码，避免使用简单组合
        </div>
    </form>
</div>

<script>
// 防抖函数实现
const debounce = (func, delay = 300) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => func.apply(this, args), delay);
    };
};

// 密码可视切换
// 密码可视切换
document.querySelectorAll('.password-toggle').forEach(toggle => {
    toggle.addEventListener('click', (e) => {
        const input = e.currentTarget.closest('.input-icon').querySelector('input');
        const icon = e.currentTarget.querySelector('i');
        const isVisible = input.type === 'text';

        input.type = isVisible ? 'password' : 'text';
        icon.classList.toggle('bi-eye-slash', !isVisible);
        icon.classList.toggle('bi-eye', isVisible);
    });
});

// 实时密码校验（带防抖）
const checkPasswordMatch = debounce(() => {
    const newPass = document.getElementById('new-password').value;
    const confirmPass = document.getElementById('confirm-password').value;
    const feedback = document.querySelector('.password-match-feedback');

    if (newPass && confirmPass) {
        const match = newPass === confirmPass;
        confirmPassInput.setCustomValidity(match ? '' : '密码不匹配');
        feedback.textContent = match ? '✅ 密码匹配' : '❌ 密码不一致';
        feedback.classList.toggle('text-success', match);
        feedback.classList.toggle('text-danger', !match);
    }
}, 200);

document.getElementById('new-password').addEventListener('input', checkPasswordMatch);
document.getElementById('confirm-password').addEventListener('input', checkPasswordMatch);

// 密码强度检测
document.getElementById('new-password').addEventListener('input', debounce(function() {
    const strengthIndicator = document.querySelector('.password-strength');
    const strength = calculateStrength(this.value);
    strengthIndicator.textContent = `强度：${strength}/4`;
    strengthIndicator.className = `password-strength text-${['danger','warning','info','success'][strength-1]} mt-2`;
}, 300));

function calculateStrength(pwd) {
    let score = 0;
    if (pwd.length >= 8) score++;
    if (/[A-Z]/.test(pwd)) score++;
    if (/\d/.test(pwd)) score++;
    if (/[^A-Za-z0-9]/.test(pwd)) score++;
    return Math.min(score, 4);
}

// Bootstrap验证增强
(() => {
    'use strict'
    const forms = document.querySelectorAll('.needs-validation')
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
})()
</script>
{% endblock %}