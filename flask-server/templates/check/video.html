{% extends "common/front_base.html" %}

{% block title %}【HorizonSafe 界安】- YOLO视频检测{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='check/css/video.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="page-title">视频目标检测系统</h1>
    
    <div id="alertBox" class="alert" role="alert" aria-live="assertive"></div>
    
    <!-- 视频上传区域 -->
    <div class="page-card">
        <div class="upload-box" id="dropArea">
            <input type="file" id="videoInput" accept="video/mp4,video/avi,video/quicktime,video/x-matroska" hidden />
            <label for="videoInput" id="uploadLabel" title="选择视频文件">
                <i class="fas fa-cloud-upload-alt" id="uploadIcon" aria-hidden="true"></i>
                <div>点击选择视频文件</div>
                <div>或拖拽文件至此</div>
                <div id="supportedFormats">(支持格式: MP4, AVI, MOV, MKV)</div>
            </label>
            <div id="progress">
                <div id="progressBar"></div>
            </div>
            <div class="loader" id="processingLoader" aria-label="正在处理视频" role="status">
                <span class="visually-hidden">正在处理视频，请稍候...</span>
            </div>
            <div id="result"></div>
            <div id="uploadActions" class="margin-top-15 hidden">
                <button id="startUploadBtn" class="button" aria-label="开始上传视频">开始上传</button>
                <button id="cancelBtn" class="button" aria-label="取消上传">取消</button>
            </div>
            <div id="helpTips">
                <p>提示: 文件大小不应超过500MB，视频长度建议不超过5分钟以获得最佳性能</p>
            </div>
        </div>
    </div>
    
    <!-- 检测结果信息 -->
    <div id="resultInfo" class="page-card hidden">
        <h2>检测结果信息</h2>
        
        <!-- 添加统计卡片 -->
        <div class="detection-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalObjectsValue">0</div>
                <div class="stat-label">检测到的目标类别数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="processingTimeValue">0s</div>
                <div class="stat-label">处理用时</div>
            </div>
        </div>
        
        <div id="processingTimeInfo" class="processing-time-info"></div>
        <div id="objectsDetectedInfo"></div>
        <div class="detection-info" id="detectionSummary" aria-live="polite"></div>
        
        <!-- 添加导出数据按钮和下拉菜单 -->
        <div class="results-actions">
            <div class="download-dropdown" id="downloadDropdown">
                <button type="button" class="download-results-btn" id="downloadBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    导出检测数据
                </button>
                <div class="download-dropdown-content" id="downloadOptions">
                    <a href="#" onclick="downloadDetectionResults('csv'); return false;">
                        <span class="download-format-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <path d="M10 12 a2 2 0 0 1 4 0v4a2 2 0 0 1-4 0v-4"></path>
                            </svg>
                        </span>
                        CSV格式
                    </a>
                    <a href="#" onclick="downloadDetectionResults('excel'); return false;">
                        <span class="download-format-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <rect x="8" y="12" width="8" height="6"></rect>
                            </svg>
                        </span>
                        Excel格式
                    </a>
                    <a href="#" onclick="downloadDetectionResults('txt'); return false;">
                        <span class="download-format-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="8" y1="13" x2="16" y2="13"></line>
                                <line x1="8" y1="17" x2="16" y2="17"></line>
                            </svg>
                        </span>
                        TXT格式
                    </a>
                </div>
            </div>
        </div>
        <a id="downloadVideoBtn" class="button">下载处理后的视频</a>
    </div>

    <!-- 视频播放区域 -->
    <div id="videoPlayerSection" class="page-card hidden">
        <h2>处理后的视频</h2>
        <video id="videoPlayer" controls width="100%" aria-label="处理后的视频播放器">
            <source id="videoSource" src="" type="video/mp4">
            <p>您的浏览器不支持视频播放，请下载视频后观看</p>
        </video>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    const API_ENDPOINT = 'http://127.0.0.1:5001/video_predict';
    let selectedFile = null;
    let xhr = null;
    
    // 显示警告或信息
    function showAlert(message, type = 'error') {
        const alertBox = document.getElementById('alertBox');
        alertBox.innerHTML = message;
        alertBox.className = 'alert alert-' + type;
        alertBox.style.display = 'block';
        
        // 5秒后自动隐藏
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 5000);
    }
    
    // 验证文件
    function validateFile(file) {
        // 检查文件类型
        const validTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-matroska'];
        if (!validTypes.includes(file.type) && 
            !file.name.match(/\.(mp4|avi|mov|mkv)$/i)) {
            showAlert('不支持的文件格式。请上传MP4、AVI、MOV或MKV格式的视频。');
            return false;
        }
        
        // 检查文件大小（限制为500MB）
        const maxSize = 500 * 1024 * 1024; // 500MB
        if (file.size > maxSize) {
            showAlert(`文件过大。最大支持500MB，当前文件大小为${(file.size/1024/1024).toFixed(2)}MB。`);
            return false;
        }
        
        return true;
    }
    
    // 文件选择处理
    document.getElementById('videoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (validateFile(file)) {
            selectedFile = file;
            prepareUpload(file);
        } else {
            // 重置输入框
            this.value = '';
            selectedFile = null;
        }
    });

    // 拖拽处理
    const dropArea = document.getElementById('dropArea');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropArea.classList.add('drag-active');
    }
    
    function unhighlight() {
        dropArea.classList.remove('drag-active');
    }
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const file = e.dataTransfer.files[0];
        if (!file) return;
        
        if (validateFile(file)) {
            selectedFile = file;
            prepareUpload(file);
        }
    }
    
    // 准备上传
    function prepareUpload(file) {
        updateStatus(`已选择: ${file.name}<br>大小: ${(file.size/1024/1024).toFixed(2)}MB`, '#2196F3');
        
        // 显示上传按钮
        const uploadActions = document.getElementById('uploadActions');
        uploadActions.classList.remove('hidden');
        uploadActions.style.display = 'block';
        
        // 重置进度条
        updateProgress(0);
    }
    
    // 开始上传按钮
    document.getElementById('startUploadBtn').addEventListener('click', function() {
        if (selectedFile) {
            this.disabled = true;
            document.getElementById('cancelBtn').style.display = 'inline-block';
            handleFile(selectedFile);
        }
    });
    
    // 取消上传按钮
    document.getElementById('cancelBtn').addEventListener('click', function() {
        if (xhr && xhr.readyState !== 4) {
            xhr.abort();
            updateStatus('上传已取消', '#f44336');
            resetUploadState();
        }
    });
    
    function resetUploadState() {
        selectedFile = null;
        document.getElementById('videoInput').value = '';
        const uploadActions = document.getElementById('uploadActions');
        uploadActions.classList.add('hidden');
        uploadActions.style.display = 'none';
        document.getElementById('startUploadBtn').disabled = false;
        document.getElementById('cancelBtn').style.display = 'none';
        updateProgress(0);
    }

    function handleFile(file) {
        if (!file) return;
        
        // 隐藏结果区域
        document.getElementById('resultInfo').style.display = 'none';
        document.getElementById('videoPlayerSection').style.display = 'none';
        
        const formData = new FormData();
        formData.append('video', file);
        
        updateStatus(`开始上传 ${file.name}...`, '#2196F3');
        
        xhr = new XMLHttpRequest();
        
        // 上传进度
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percent = (e.loaded / e.total * 100).toFixed(1);
                updateProgress(percent);
                updateStatus(`上传中: ${percent}%`, '#2196F3');
            }
        });
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                document.getElementById('cancelBtn').style.display = 'none';
                
                if (xhr.status === 200) {
                    // 上传完成，等待处理
                    updateStatus('上传完成，服务器正在处理...', '#2196F3');
                    
                    // 隐藏进度条，显示加载指示器
                    document.getElementById('progress').style.display = 'none';
                    document.getElementById('processingLoader').style.display = 'block';
                    
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.download_url) {
                            // 隐藏加载指示器
                            document.getElementById('processingLoader').style.display = 'none';
                            showResults(response);
                            resetUploadState();
                            showAlert('视频处理完成！', 'info');
                        } else {
                            document.getElementById('processingLoader').style.display = 'none';
                            resetUploadState();
                            showAlert(`处理失败: ${response.error || '未知错误'}`);
                            updateStatus(`处理失败: ${response.error || '未知错误'}`, '#f44336');
                        }
                    } catch (e) {
                        document.getElementById('processingLoader').style.display = 'none';
                        resetUploadState();
                        showAlert(`解析响应失败: ${e.message}`);
                        updateStatus(`解析响应失败: ${e.message}`, '#f44336');
                        console.error('响应解析错误', e, xhr.responseText);
                    }
                } else if (xhr.status !== 0) { // 0表示请求被取消
                    document.getElementById('processingLoader').style.display = 'none';
                    resetUploadState();
                    showAlert(`服务器错误 (${xhr.status}): ${xhr.statusText || '未知错误'}`);
                    updateStatus(`服务器错误 (${xhr.status}): ${xhr.statusText || '未知错误'}`, '#f44336');
                }
            }
        };
        
        xhr.onerror = function() {
            document.getElementById('processingLoader').style.display = 'none';
            resetUploadState();
            showAlert('网络错误，请检查服务器连接');
            updateStatus('网络错误，请检查服务器连接', '#f44336');
        };
        
        xhr.open('POST', API_ENDPOINT, true);
        xhr.send(formData);
    }

    function updateProgress(percent) {
        document.getElementById('progressBar').style.width = percent + '%';
    }

    function updateStatus(text, color = '#000') {
        document.getElementById('uploadLabel').innerHTML = `
            <i class="fas fa-cloud-upload-alt" id="uploadIcon"></i>
            <div style="color:${color}">${text}</div>
            <div id="supportedFormats">(支持格式: MP4, AVI, MOV, MKV)</div>
        `;
    }

    function generateRandomColor() {
        const hue = Math.floor(Math.random() * 360);
        return `hsl(${hue}, 70%, 60%)`;
    }

    function showResults(response) {
        // 添加调试信息
        console.log('收到服务器响应:', response);
        
        const videoFilename = response.download_url.split('/').pop();
        const downloadUrl = `http://127.0.0.1:5001${response.download_url}`;
        
        // 显示结果区域
        const resultInfo = document.getElementById('resultInfo');
        resultInfo.classList.remove('hidden');
        resultInfo.style.display = 'block';
        
        // 设置处理用时（只保留整数部分）
        const processingTime = response.processing_time || '未知';
        const processingTimeInt = typeof processingTime === 'number' ? Math.floor(processingTime) : processingTime;
        document.getElementById('processingTimeInfo').innerText = `处理用时: ${processingTimeInt}秒`;
        document.getElementById('processingTimeValue').innerText = `${processingTimeInt}秒`;
        
        // 修改检测数据处理逻辑，适应app.py的返回格式
        if (response.detections && Array.isArray(response.detections)) {
            console.log('检测结果数组长度:', response.detections.length);
            if (response.detections.length > 0) {
                console.log('检测数据样本:', response.detections[0]);
            }
            
            // 用于跟踪已经出现过的类别
            const uniqueClasses = new Set();
            // 恢复类别计数，用于计算比例
            const classObjectCounts = {};
            
            // 扁平化处理所有检测结果
            response.detections.forEach(detection => {
                // 直接处理每个检测对象，提取类别信息
                processDetection(detection, uniqueClasses, classObjectCounts);
            });
            
            // 计算检测到的总类别出现次数
            const totalOccurrences = Object.values(classObjectCounts).reduce((sum, count) => sum + count, 0);
            
            console.log('唯一类别:', Array.from(uniqueClasses));
            console.log('类别出现次数:', classObjectCounts);
            console.log('总出现次数:', totalOccurrences);
            
            // 更新统计卡片 - 只显示唯一类别的数量
            document.getElementById('totalObjectsValue').innerText = uniqueClasses.size;
            
            // 显示总数
            document.getElementById('objectsDetectedInfo').innerText = 
                `共检测到 ${uniqueClasses.size} 种目标类别`;
            
            // 显示对象类别统计
            let summaryHTML = '<h3>目标类别统计</h3><div class="class-item-container">';
            
            // 为每个类别生成随机颜色
            const classColors = {};
            for (const className of uniqueClasses) {
                classColors[className] = generateRandomColor();
            }
            
            // 创建更视觉化的统计 - 根据类别出现次数计算比例
            for (const [className, count] of Object.entries(classObjectCounts)) {
                const percentage = ((count / totalOccurrences) * 100).toFixed(1);
                summaryHTML += `
                    <div class="detect-item class-item">
                        <div class="class-color" style="background-color: ${classColors[className]}"></div>
                        <div>
                            <strong>${className}</strong>: ${count}次 (${percentage}%)
                        </div>
                    </div>`;
            }
            summaryHTML += '</div>';
            
            document.getElementById('detectionSummary').innerHTML = summaryHTML;
        } else {
            console.log('没有检测结果或结果格式错误');
            document.getElementById('totalObjectsValue').innerText = '0';
            document.getElementById('objectsDetectedInfo').innerText = '暂无检测数据';
            document.getElementById('detectionSummary').innerHTML = '';
        }
        
        // 设置下载按钮
        const downloadBtn = document.getElementById('downloadVideoBtn');
        downloadBtn.href = downloadUrl;
        downloadBtn.download = videoFilename;
        downloadBtn.title = `下载处理后的视频: ${videoFilename}`;
        downloadBtn.setAttribute('aria-label', `下载处理后的视频: ${videoFilename}`);
        
        // 设置视频播放器
        if (response.stream_url) {
            const videoSource = document.getElementById('videoSource');
            videoSource.src = `http://127.0.0.1:5001${response.stream_url}`;
            
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.load(); // 重新加载视频元素以应用新的源
            videoPlayer.setAttribute('aria-label', `处理后的视频: ${videoFilename}`);
            
            // 显示视频播放区域
            const videoSection = document.getElementById('videoPlayerSection');
            videoSection.classList.remove('hidden');
            videoSection.style.display = 'block';
            setTimeout(() => {
                videoSection.classList.add('visible');
            }, 100);
        }
        
        // 显示结果区域并添加动画效果
        setTimeout(() => {
            resultInfo.classList.add('visible');
        }, 100);
        
        // 重置上传框的状态
        document.getElementById('processingLoader').style.display = 'none';
        document.getElementById('progress').style.display = 'block';
        updateProgress(0);
        updateStatus('上传新视频进行检测', '#000');
        
        // 初始化下拉菜单
        initializeDropdown();
    }
    
    // 添加辅助函数，处理检测对象
    function processDetection(detection, uniqueClasses, classObjectCounts) {
        console.log('处理检测对象:', detection);
        
        // 尝试获取类别名称，优先使用class_name字段
        let className = null;
        if (detection.class_name) {
            className = detection.class_name;
        } else if (detection.class) {
            className = detection.class;
        } else if (detection.name) {
            className = detection.name;
        } else if (detection.type) {
            className = detection.type;
        } else {
            className = '未知类别';
        }
        
        // 打印调试信息帮助追踪
        console.log('提取的类别:', className, '来源字段:', 
            detection.class_name ? 'class_name' : 
            detection.class ? 'class' : 
            detection.name ? 'name' : 
            detection.type ? 'type' : '无');
        
        // 统计每个类别的出现次数
        classObjectCounts[className] = (classObjectCounts[className] || 0) + 1;
        // 记录唯一类别
        uniqueClasses.add(className);
    }
    
    // 添加下载检测结果函数
    function downloadDetectionResults(format = 'csv') {
        // 检查是否有检测数据
        const detectionSummary = document.getElementById('detectionSummary');
        if (!detectionSummary || !detectionSummary.innerHTML.trim()) {
            showAlert('没有可导出的检测数据', 'error');
            return;
        }
        
        // 获取类别数据
        const classItems = document.querySelectorAll('.detect-item');
        if (classItems.length === 0) {
            showAlert('没有可导出的检测数据', 'error');
            return;
        }
        
        // 设置当前日期时间作为文件名的一部分
        const now = new Date();
        const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
        let fileContent = '';
        let mimeType = '';
        let fileExtension = '';
        let successMessage = '';
        
        // 从DOM中收集数据
        const classData = [];
        classItems.forEach(item => {
            const nameElement = item.querySelector('strong');
            const countText = item.textContent.trim();
            
            // 提取类别名称和百分比及检测次数
            const className = nameElement ? nameElement.textContent.trim() : '未知类别';
            const countMatch = countText.match(/(\d+)次/);
            const count = countMatch ? parseInt(countMatch[1]) : 0;
            const percentMatch = countText.match(/\((\d+\.\d+)%\)/);
            const percentage = percentMatch ? percentMatch[1] : '0.0';
            
            classData.push({
                className,
                count,
                percentage
            });
        });
        
        // 获取唯一类别数
        const classesCountText = document.getElementById('totalObjectsValue').textContent;
        const classesCount = parseInt(classesCountText) || 0;
        
        // 根据不同格式生成不同内容
        switch (format) {
            case 'csv':
                // 创建CSV内容
                fileContent = "类别,检测次数,百分比\n";
                classData.forEach(data => {
                    fileContent += `"${data.className}",${data.count},${data.percentage}%\n`;
                });
                mimeType = 'text/csv;charset=utf-8;';
                fileExtension = 'csv';
                successMessage = '检测结果已成功导出为CSV文件';
                break;
                
            case 'excel':
                // 创建Excel兼容的CSV内容（Excel可以打开CSV文件）
                fileContent = "\ufeff类别,检测次数,百分比\n"; // 添加BOM标记以支持中文
                classData.forEach(data => {
                    fileContent += `"${data.className}",${data.count},${data.percentage}%\n`;
                });
                mimeType = 'application/vnd.ms-excel;charset=utf-8;';
                fileExtension = 'xls';
                successMessage = '检测结果已成功导出为Excel文件';
                break;
                
            case 'txt':
                // 创建TXT内容
                fileContent = "视频检测结果报告\n";
                fileContent += "===================\n\n";
                fileContent += `生成时间: ${now.toLocaleString()}\n`;
                fileContent += `检测到的目标类别数: ${classesCount}\n\n`;
                fileContent += "类别统计:\n";
                fileContent += "-----------------\n";
                
                classData.forEach((data, index) => {
                    fileContent += `${index + 1}. ${data.className}: ${data.count}次 (${data.percentage}%)\n`;
                });
                
                mimeType = 'text/plain;charset=utf-8;';
                fileExtension = 'txt';
                successMessage = '检测结果已成功导出为TXT文件';
                break;
        }
        
        // 创建下载链接
        const blob = new Blob([fileContent], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        link.setAttribute('href', url);
        link.setAttribute('download', `video-detection-results-${timestamp}.${fileExtension}`);
        link.style.visibility = 'hidden';
        
        // 添加到DOM，触发下载，然后移除
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // 显示成功提示
        showAlert(successMessage, 'info');
    }
    
    // 初始化下拉菜单功能
    function initializeDropdown() {
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadOptions = document.getElementById('downloadOptions');
        
        if (downloadBtn && downloadOptions) {
            // 点击按钮时显示/隐藏下拉菜单
            downloadBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                downloadOptions.classList.toggle('show');
            });
            
            // 点击页面其他位置关闭下拉菜单
            document.addEventListener('click', function(e) {
                if (!downloadBtn.contains(e.target) && !downloadOptions.contains(e.target)) {
                    downloadOptions.classList.remove('show');
                }
            });
            
            // 为选项添加点击事件，选择后关闭下拉菜单
            const options = downloadOptions.querySelectorAll('a');
            options.forEach(option => {
                option.addEventListener('click', function() {
                    downloadOptions.classList.remove('show');
                });
            });
        }
    }
    
    // 初始化时设置上传图标
    updateStatus('点击选择视频文件<br>或拖拽文件至此', '#000');
</script>
{% endblock %}