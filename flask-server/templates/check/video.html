{% extends "common/front_base.html" %}

{% block title %}YOLO视频检测 - 慧眼通途{% endblock %}

{% block css %}
<style>
    .upload-box { 
        border: 2px dashed #ccc; 
        padding: 30px; 
        text-align: center; 
        border-radius: 10px;
        background-color: #f9f9f9;
        transition: all 0.3s ease;
    }
    .upload-box:hover {
        border-color: var(--primary-color);
        background-color: #f0f7f0;
    }
    .upload-box.drag-active {
        border-color: var(--primary-color);
        background-color: rgba(76, 175, 80, 0.1);
        transform: scale(1.01);
    }
    #progress { 
        margin-top: 15px; 
        height: 10px; 
        background: #f0f0f0;
        border-radius: 5px;
        overflow: hidden;
    }
    #progressBar { 
        width: 0%; 
        height: 100%; 
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color, #8bc34a));
        transition: width 0.3s;
        border-radius: 5px;
    }
    .loader {
        display: none;
        margin: 25px auto;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--accent-color, #3498db);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1.5s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .detection-info {
        margin-top: 20px;
        padding: 15px;
        background: #f0f7ff;
        border-radius: 8px;
        border-left: 4px solid var(--accent-color, #2196F3);
    }
    #resultInfo, #videoPlayerSection {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
    }
    #resultInfo.visible, #videoPlayerSection.visible {
        opacity: 1;
        transform: translateY(0);
    }
    #uploadLabel {
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        display: block;
    }
    #uploadLabel:hover {
        color: var(--primary-color, #4CAF50);
    }
    #uploadIcon {
        font-size: 48px;
        color: var(--primary-color, #4CAF50);
        margin-bottom: 15px;
        opacity: 0.8;
    }
    video {
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    .page-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 20px;
    }
    .button { 
        padding: 10px 20px; 
        background: var(--primary-color, #4CAF50); 
        color: white; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
        text-decoration: none;
        transition: all 0.3s;
        display: inline-block;
        margin-top: 15px;
        font-weight: 500;
    }
    .button:hover { 
        background: var(--primary-darker, #45a049); 
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .button:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: none;
    }
    .alert-error {
        background-color: #ffebee;
        border-left: 4px solid #f44336;
        color: #b71c1c;
    }
    .alert-info {
        background-color: #e3f2fd;
        border-left: 4px solid #2196F3;
        color: #0d47a1;
    }
    .detection-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 15px;
    }
    .stat-card {
        background: #f5f5f5;
        border-radius: 8px;
        padding: 15px;
        flex: 1;
        min-width: 150px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .stat-card .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-color, #4CAF50);
    }
    .stat-card .stat-label {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
    }
    .detect-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    .detect-item .class-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        margin-right: 10px;
    }
    #cancelBtn {
        background-color: #f44336;
        margin-left: 10px;
        display: none;
    }
    #cancelBtn:hover {
        background-color: #d32f2f;
    }
    #helpTips {
        margin-top: 15px;
        color: #666;
        font-size: 14px;
    }
    /* 新增的CSS类，用于替换内联样式 */
    .hidden {
        display: none;
    }
    .margin-top-15 {
        margin-top: 15px;
    }
    .processing-time-info {
        margin-top: 15px;
    }
    .class-item-container {
        display: flex; 
        flex-wrap: wrap;
    }
    .class-item {
        flex: 0 0 33.33%; 
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="page-title">视频目标检测系统</h1>
    
    <div id="alertBox" class="alert" role="alert" aria-live="assertive"></div>
    
    <!-- 视频上传区域 -->
    <div class="page-card">
        <div class="upload-box" id="dropArea">
            <input type="file" id="videoInput" accept="video/mp4,video/avi,video/quicktime,video/x-matroska" hidden />
            <label for="videoInput" id="uploadLabel" title="选择视频文件">
                <i class="fas fa-cloud-upload-alt" id="uploadIcon" aria-hidden="true"></i>
                <div>点击选择视频文件</div>
                <div>或拖拽文件至此</div>
                <div id="supportedFormats">(支持格式: MP4, AVI, MOV, MKV)</div>
            </label>
            <div id="progress">
                <div id="progressBar"></div>
            </div>
            <div class="loader" id="processingLoader" aria-label="正在处理视频" role="status">
                <span class="visually-hidden">正在处理视频，请稍候...</span>
            </div>
            <div id="result"></div>
            <div id="uploadActions" class="margin-top-15 hidden">
                <button id="startUploadBtn" class="button" aria-label="开始上传视频">开始上传</button>
                <button id="cancelBtn" class="button" aria-label="取消上传">取消</button>
            </div>
            <div id="helpTips">
                <p>提示: 文件大小不应超过500MB，视频长度建议不超过5分钟以获得最佳性能</p>
            </div>
        </div>
    </div>
    
    <!-- 检测结果信息 -->
    <div id="resultInfo" class="page-card hidden">
        <h2>检测结果信息</h2>
        
        <!-- 添加统计卡片 -->
        <div class="detection-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalObjectsValue">0</div>
                <div class="stat-label">检测到的目标总数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="classesValue">0</div>
                <div class="stat-label">目标类别数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="processingTimeValue">0s</div>
                <div class="stat-label">处理用时</div>
            </div>
        </div>
        
        <div id="processingTimeInfo" class="processing-time-info"></div>
        <div id="objectsDetectedInfo"></div>
        <div class="detection-info" id="detectionSummary" aria-live="polite"></div>
        <div class="detection-info" id="detectionSummary"></div>
        <a id="downloadBtn" class="button">下载处理后的视频</a>
    </div>

    <!-- 视频播放区域 -->
    <div id="videoPlayerSection" class="page-card hidden">
        <h2>处理后的视频</h2>
        <video id="videoPlayer" controls width="100%" aria-label="处理后的视频播放器">
            <source id="videoSource" src="" type="video/mp4">
            <p>您的浏览器不支持视频播放，请下载视频后观看</p>
        </video>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    const API_ENDPOINT = 'http://127.0.0.1:5001/video_predict';
    let selectedFile = null;
    let xhr = null;
    
    // 显示警告或信息
    function showAlert(message, type = 'error') {
        const alertBox = document.getElementById('alertBox');
        alertBox.innerHTML = message;
        alertBox.className = 'alert alert-' + type;
        alertBox.style.display = 'block';
        
        // 5秒后自动隐藏
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 5000);
    }
    
    // 验证文件
    function validateFile(file) {
        // 检查文件类型
        const validTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-matroska'];
        if (!validTypes.includes(file.type) && 
            !file.name.match(/\.(mp4|avi|mov|mkv)$/i)) {
            showAlert('不支持的文件格式。请上传MP4、AVI、MOV或MKV格式的视频。');
            return false;
        }
        
        // 检查文件大小（限制为500MB）
        const maxSize = 500 * 1024 * 1024; // 500MB
        if (file.size > maxSize) {
            showAlert(`文件过大。最大支持500MB，当前文件大小为${(file.size/1024/1024).toFixed(2)}MB。`);
            return false;
        }
        
        return true;
    }
    
    // 文件选择处理
    document.getElementById('videoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (validateFile(file)) {
            selectedFile = file;
            prepareUpload(file);
        } else {
            // 重置输入框
            this.value = '';
            selectedFile = null;
        }
    });

    // 拖拽处理
    const dropArea = document.getElementById('dropArea');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropArea.classList.add('drag-active');
    }
    
    function unhighlight() {
        dropArea.classList.remove('drag-active');
    }
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const file = e.dataTransfer.files[0];
        if (!file) return;
        
        if (validateFile(file)) {
            selectedFile = file;
            prepareUpload(file);
        }
    }
    
    // 准备上传
    function prepareUpload(file) {
        updateStatus(`已选择: ${file.name}<br>大小: ${(file.size/1024/1024).toFixed(2)}MB`, '#2196F3');
        
        // 显示上传按钮
        const uploadActions = document.getElementById('uploadActions');
        uploadActions.classList.remove('hidden');
        uploadActions.style.display = 'block';
        
        // 重置进度条
        updateProgress(0);
    }
    
    // 开始上传按钮
    document.getElementById('startUploadBtn').addEventListener('click', function() {
        if (selectedFile) {
            this.disabled = true;
            document.getElementById('cancelBtn').style.display = 'inline-block';
            handleFile(selectedFile);
        }
    });
    
    // 取消上传按钮
    document.getElementById('cancelBtn').addEventListener('click', function() {
        if (xhr && xhr.readyState !== 4) {
            xhr.abort();
            updateStatus('上传已取消', '#f44336');
            resetUploadState();
        }
    });
    
    function resetUploadState() {
        selectedFile = null;
        document.getElementById('videoInput').value = '';
        const uploadActions = document.getElementById('uploadActions');
        uploadActions.classList.add('hidden');
        uploadActions.style.display = 'none';
        document.getElementById('startUploadBtn').disabled = false;
        document.getElementById('cancelBtn').style.display = 'none';
        updateProgress(0);
    }

    function handleFile(file) {
        if (!file) return;
        
        // 隐藏结果区域
        document.getElementById('resultInfo').style.display = 'none';
        document.getElementById('videoPlayerSection').style.display = 'none';
        
        const formData = new FormData();
        formData.append('video', file);
        
        updateStatus(`开始上传 ${file.name}...`, '#2196F3');
        
        xhr = new XMLHttpRequest();
        
        // 上传进度
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percent = (e.loaded / e.total * 100).toFixed(1);
                updateProgress(percent);
                updateStatus(`上传中: ${percent}%`, '#2196F3');
            }
        });
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                document.getElementById('cancelBtn').style.display = 'none';
                
                if (xhr.status === 200) {
                    // 上传完成，等待处理
                    updateStatus('上传完成，服务器正在处理...', '#2196F3');
                    
                    // 隐藏进度条，显示加载指示器
                    document.getElementById('progress').style.display = 'none';
                    document.getElementById('processingLoader').style.display = 'block';
                    
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.download_url) {
                            // 隐藏加载指示器
                            document.getElementById('processingLoader').style.display = 'none';
                            showResults(response);
                            resetUploadState();
                            showAlert('视频处理完成！', 'info');
                        } else {
                            document.getElementById('processingLoader').style.display = 'none';
                            resetUploadState();
                            showAlert(`处理失败: ${response.error || '未知错误'}`);
                            updateStatus(`处理失败: ${response.error || '未知错误'}`, '#f44336');
                        }
                    } catch (e) {
                        document.getElementById('processingLoader').style.display = 'none';
                        resetUploadState();
                        showAlert(`解析响应失败: ${e.message}`);
                        updateStatus(`解析响应失败: ${e.message}`, '#f44336');
                        console.error('响应解析错误', e, xhr.responseText);
                    }
                } else if (xhr.status !== 0) { // 0表示请求被取消
                    document.getElementById('processingLoader').style.display = 'none';
                    resetUploadState();
                    showAlert(`服务器错误 (${xhr.status}): ${xhr.statusText || '未知错误'}`);
                    updateStatus(`服务器错误 (${xhr.status}): ${xhr.statusText || '未知错误'}`, '#f44336');
                }
            }
        };
        
        xhr.onerror = function() {
            document.getElementById('processingLoader').style.display = 'none';
            resetUploadState();
            showAlert('网络错误，请检查服务器连接');
            updateStatus('网络错误，请检查服务器连接', '#f44336');
        };
        
        xhr.open('POST', API_ENDPOINT, true);
        xhr.send(formData);
    }

    function updateProgress(percent) {
        document.getElementById('progressBar').style.width = percent + '%';
    }

    function updateStatus(text, color = '#000') {
        document.getElementById('uploadLabel').innerHTML = `
            <i class="fas fa-cloud-upload-alt" id="uploadIcon"></i>
            <div style="color:${color}">${text}</div>
            <div id="supportedFormats">(支持格式: MP4, AVI, MOV, MKV)</div>
        `;
    }

    function generateRandomColor() {
        const hue = Math.floor(Math.random() * 360);
        return `hsl(${hue}, 70%, 60%)`;
    }

    function showResults(response) {
        const videoFilename = response.download_url.split('/').pop();
        const downloadUrl = `http://127.0.0.1:5001${response.download_url}`;
        
        // 显示结果区域
        const resultInfo = document.getElementById('resultInfo');
        resultInfo.classList.remove('hidden');
        resultInfo.style.display = 'block';
        
        // 设置处理用时
        const processingTime = response.processing_time || '未知';
        document.getElementById('processingTimeInfo').innerText = `处理用时: ${processingTime}`;
        document.getElementById('processingTimeValue').innerText = processingTime;
        
        // 检查是否有检测数据并显示摘要
        if (response.detections && Array.isArray(response.detections)) {
            // 计算检测到的对象总数和分类统计
            const allObjects = [];
            response.detections.forEach(frameDetections => {
                if (Array.isArray(frameDetections)) {
                    frameDetections.forEach(detection => {
                        allObjects.push(detection.class);
                    });
                }
            });
            
            // 对象计数
            const objectCounts = {};
            allObjects.forEach(obj => {
                objectCounts[obj] = (objectCounts[obj] || 0) + 1;
            });
            
            // 更新统计卡片
            document.getElementById('totalObjectsValue').innerText = allObjects.length;
            document.getElementById('classesValue').innerText = Object.keys(objectCounts).length;
            
            // 显示总数
            document.getElementById('objectsDetectedInfo').innerText = 
                `共检测到 ${allObjects.length} 个目标对象，涵盖 ${Object.keys(objectCounts).length} 种类别`;
            
            // 显示对象类别统计
            let summaryHTML = '<h3>目标检测统计</h3><div class="class-item-container">';
            
            // 为每个类别生成随机颜色
            const classColors = {};
            for (const className of Object.keys(objectCounts)) {
                classColors[className] = generateRandomColor();
            }
            
            // 创建更视觉化的统计
            for (const [className, count] of Object.entries(objectCounts)) {
                const percentage = ((count / allObjects.length) * 100).toFixed(1);
                summaryHTML += `
                    <div class="detect-item class-item">
                        <div class="class-color" style="background-color: ${classColors[className]}"></div>
                        <div>
                            <strong>${className}</strong>: ${count}个 (${percentage}%)
                        </div>
                    </div>`;
            }
            summaryHTML += '</div>';
            
            // 添加饼图或柱状图可视化统计（如果有需要，这里可以集成图表库）
            
            document.getElementById('detectionSummary').innerHTML = summaryHTML;
        } else {
            document.getElementById('totalObjectsValue').innerText = '0';
            document.getElementById('classesValue').innerText = '0';
            document.getElementById('objectsDetectedInfo').innerText = '暂无检测数据';
            document.getElementById('detectionSummary').innerHTML = '';
        }
        
        // 设置下载按钮
        const downloadBtn = document.getElementById('downloadBtn');
        downloadBtn.href = downloadUrl;
        downloadBtn.download = videoFilename;
        downloadBtn.title = `下载处理后的视频: ${videoFilename}`;
        downloadBtn.setAttribute('aria-label', `下载处理后的视频: ${videoFilename}`);
        
        // 设置视频播放器
        if (response.stream_url) {
            const videoSource = document.getElementById('videoSource');
            videoSource.src = `http://127.0.0.1:5001${response.stream_url}`;
            
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.load(); // 重新加载视频元素以应用新的源
            videoPlayer.setAttribute('aria-label', `处理后的视频: ${videoFilename}`);
            
            // 显示视频播放区域
            const videoSection = document.getElementById('videoPlayerSection');
            videoSection.classList.remove('hidden');
            videoSection.style.display = 'block';
            setTimeout(() => {
                videoSection.classList.add('visible');
            }, 100);
        }
        
        // 显示结果区域并添加动画效果
        setTimeout(() => {
            resultInfo.classList.add('visible');
        }, 100);
        
        // 重置上传框的状态
        document.getElementById('processingLoader').style.display = 'none';
        document.getElementById('progress').style.display = 'block';
        updateProgress(0);
        updateStatus('上传新视频进行检测', '#000');
    }
    
    // 初始化时设置上传图标
    updateStatus('点击选择视频文件<br>或拖拽文件至此', '#000');
</script>
{% endblock %}