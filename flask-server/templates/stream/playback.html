{% extends "common/front_base.html" %}

{% block title %}监控回放{% endblock %}

{% block css %}
<style>
    /* 主容器样式 */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* 页面标题 */
    .page-title {
        font-size: 1.8rem;
        margin-bottom: 25px;
        color: #333;
        border-bottom: 2px solid var(--primary-500);
        padding-bottom: 10px;
    }
    
    /* 视频列表和播放器布局 */
    .playback-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    /* 视频列表区域 */
    .video-list-container {
        flex: 1;
        min-width: 300px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    /* 播放器区域 */
    .player-container {
        flex: 2;
        min-width: 500px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    /* 视频列表头部 */
    .video-list-header {
        background-color: var(--primary-500);
        color: white;
        padding: 15px 20px;
        font-size: 1.2rem;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .video-count {
        font-size: 0.9rem;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 3px 8px;
        border-radius: 12px;
    }
    
    /* 视频列表样式 */
    .video-list {
        max-height: 600px;
        overflow-y: auto;
        padding: 0;
        margin: 0;
        list-style-type: none;
    }
    
    /* 视频列表项 */
    .video-item {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
        position: relative;
    }
    
    .video-item:hover {
        background-color: #f8f9fa;
    }
    
    .video-item.active {
        background-color: rgba(0, 123, 255, 0.1);
        border-left: 3px solid var(--primary-500);
    }
    
    .video-title {
        font-weight: 500;
        margin-bottom: 5px;
        color: #333;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .video-info {
        font-size: 0.85rem;
        color: #666;
        display: flex;
        gap: 15px;
    }
    
    .video-date, .video-size {
        display: flex;
        align-items: center;
    }
    
    .video-date i, .video-size i {
        margin-right: 5px;
        color: #888;
    }
    
    /* 视频操作按钮 */
    .video-actions {
        position: absolute;
        right: 15px;
        top: 15px;
        display: none;
    }
    
    .video-item:hover .video-actions {
        display: flex;
    }
    
    .video-action-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: all 0.2s;
    }
    
    .video-action-btn:hover {
        background-color: rgba(0, 0, 0, 0.05);
        color: #333;
    }
    
    .video-action-btn.delete:hover {
        color: #dc3545;
    }
    
    /* 播放器头部 */
    .player-header {
        background-color: #343a40;
        color: white;
        padding: 15px 20px;
        font-size: 1.2rem;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* 视频播放器容器 */
    .video-player-container {
        background-color: #000;
        position: relative;
        padding-top: 56.25%; /* 16:9 宽高比 */
        overflow: hidden;
    }
    
    #videoPlayer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
    }
    
    /* 播放器控制栏 */
    .player-controls {
        padding: 15px;
        background-color: #f8f9fa;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .control-btn {
        background-color: var(--primary-500);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background-color 0.2s;
    }
    
    .control-btn:hover {
        background-color: var(--primary-600);
    }
    
    .control-btn.secondary {
        background-color: #6c757d;
    }
    
    .control-btn.secondary:hover {
        background-color: #5a6268;
    }
    
    .control-btn i {
        font-size: 0.9rem;
    }
    
    /* 播放速度控制 */
    .playback-speed {
        display: flex;
        align-items: center;
        margin-left: auto;
    }
    
    .playback-speed label {
        margin-right: 8px;
        color: #555;
        font-size: 0.9rem;
    }
    
    .playback-speed select {
        padding: 5px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: white;
    }
    
    /* 播放器底部信息 */
    .player-footer {
        padding: 15px;
        background-color: #fff;
        border-top: 1px solid #eee;
        font-size: 0.9rem;
        color: #666;
    }
    
    .player-info {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    .player-info-item {
        display: flex;
        align-items: center;
    }
    
    .player-info-item i {
        margin-right: 8px;
        color: #888;
    }
    
    /* 空状态 */
    .empty-state {
        padding: 40px 20px;
        text-align: center;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #adb5bd;
    }
    
    .empty-state-text {
        font-size: 1.1rem;
        margin-bottom: 10px;
    }
    
    /* 加载状态 */
    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 123, 255, 0.2);
        border-top-color: #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* 确认弹窗 */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }
    
    .modal.visible {
        display: flex;
    }
    
    .modal-content {
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        font-weight: 500;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 15px 20px;
        background-color: #f8f9fa;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid #e9ecef;
    }
    
    .modal-btn {
        padding: 8px 15px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
    }
    
    .modal-btn.cancel {
        background-color: #e9ecef;
        color: #495057;
    }
    
    .modal-btn.delete {
        background-color: #dc3545;
        color: white;
    }
    
    .modal-btn.cancel:hover {
        background-color: #dee2e6;
    }
    
    .modal-btn.delete:hover {
        background-color: #c82333;
    }
    
    /* 响应式调整 */
    @media (max-width: 992px) {
        .playback-container {
            flex-direction: column;
        }
        
        .player-container, .video-list-container {
            width: 100%;
            min-width: 100%;
        }
        
        .player-container {
            order: 1;
        }
        
        .video-list-container {
            order: 2;
        }
    }
    
    /* 提示消息 */
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #333;
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 9999;
    }
    
    .toast.success {
        background-color: #28a745;
    }
    
    .toast.error {
        background-color: #dc3545;
    }
    
    .toast.show {
        opacity: 1;
    }
    
    /* 无记录时的样式 */
    .no-records {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .no-records-icon {
        font-size: 3rem;
        color: #adb5bd;
        margin-bottom: 20px;
    }
    
    .no-records-text {
        font-size: 1.1rem;
        margin-bottom: 10px;
    }
    
    .no-records-hint {
        font-size: 0.9rem;
        color: #868e96;
        margin-bottom: 20px;
    }
    
    .no-records-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background-color: var(--primary-500);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 0.9rem;
        text-decoration: none;
    }
    
    .no-records-btn:hover {
        background-color: var(--primary-600);
        text-decoration: none;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="page-title">监控回放</h1>
    
    <div class="playback-container">
        <!-- 视频播放器区域 -->
        <div class="player-container">
            <div class="player-header">
                <span id="currentVideoTitle">监控视频回放</span>
            </div>
            
            <div class="video-player-container">
                <video id="videoPlayer" controls>
                    <source src="" type="video/mp4">
                    您的浏览器不支持HTML5视频播放
                </video>
            </div>
            
            <div class="player-controls">
                <button id="playBtn" class="control-btn">
                    <i class="fas fa-play"></i> 播放
                </button>
                
                <button id="pauseBtn" class="control-btn secondary">
                    <i class="fas fa-pause"></i> 暂停
                </button>
                
                <button id="stopBtn" class="control-btn secondary">
                    <i class="fas fa-stop"></i> 停止
                </button>
                
                <button id="fullscreenBtn" class="control-btn secondary">
                    <i class="fas fa-expand"></i> 全屏
                </button>
                
                <div class="playback-speed">
                    <label for="speedSelect">播放速度:</label>
                    <select id="speedSelect">
                        <option value="0.25">0.25x</option>
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                        <option value="4">4x</option>
                    </select>
                </div>
            </div>
            
            <div class="player-footer">
                <div class="player-info">
                    <div class="player-info-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="videoDate">--</span>
                    </div>
                    <div class="player-info-item">
                        <i class="fas fa-file-video"></i>
                        <span id="videoSize">--</span>
                    </div>
                    <div class="player-info-item">
                        <i class="fas fa-clock"></i>
                        <span id="videoDuration">--:--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 视频列表区域 -->
        <div class="video-list-container">
            <div class="video-list-header">
                <span>回放记录</span>
                <span class="video-count">{{ video_files|length }} 个记录</span>
            </div>
            
            {% if video_files %}
            <ul class="video-list" id="videoList">
                {% for video in video_files %}
                <li class="video-item" data-file="{{ video.filename }}" data-path="{{ video.path }}" data-date="{{ video.timestamp }}" data-size="{{ video.size }}">
                    <div class="video-title">{{ video.filename }}</div>
                    <div class="video-info">
                        <div class="video-date">
                            <i class="fas fa-calendar-alt"></i>
                            <span>{{ video.timestamp }}</span>
                        </div>
                        <div class="video-size">
                            <i class="fas fa-file-video"></i>
                            <span>{{ video.size }}</span>
                        </div>
                    </div>
                    <div class="video-actions">
                        <button class="video-action-btn download" title="下载" onclick="downloadVideo('{{ video.path }}', '{{ video.filename }}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="video-action-btn delete" title="删除" onclick="confirmDelete('{{ video.filename }}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="no-records">
                <div class="no-records-icon">
                    <i class="fas fa-video-slash"></i>
                </div>
                <p class="no-records-text">暂无回放记录</p>
                <p class="no-records-hint">开始视频监控并保存记录后可在此查看</p>
                <a href="{{ url_for('check.monitor') }}" class="no-records-btn">
                    <i class="fas fa-video"></i> 前往视频监控
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 确认删除弹窗 -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            确认删除
        </div>
        <div class="modal-body">
            您确定要删除这个视频记录吗？此操作无法撤销。
            <div id="deleteFileName" style="margin-top: 10px; font-weight: 500;"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal()">取消</button>
            <button class="modal-btn delete" id="confirmDeleteBtn">删除</button>
        </div>
    </div>
</div>

<!-- 提示消息 -->
<div class="toast" id="toast"></div>
{% endblock %}

{% block js %}
<script>
    // DOM元素
    const videoPlayer = document.getElementById('videoPlayer');
    const videoList = document.getElementById('videoList');
    const currentVideoTitle = document.getElementById('currentVideoTitle');
    const videoDate = document.getElementById('videoDate');
    const videoSize = document.getElementById('videoSize');
    const videoDuration = document.getElementById('videoDuration');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const speedSelect = document.getElementById('speedSelect');
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteFileName = document.getElementById('deleteFileName');
    const toast = document.getElementById('toast');
    
    // 当前选中的视频
    let currentVideo = null;
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 如果有视频，默认选中第一个
        if (videoList) {
            const firstVideo = videoList.querySelector('.video-item');
            if (firstVideo) {
                selectVideo(firstVideo);
            }
        }
        
        // 设置视频播放器事件监听
        setupVideoEvents();
        
        // 设置控制按钮事件监听
        setupControlEvents();
    });
    
    // 初始化视频播放器事件
    function setupVideoEvents() {
        // 视频加载完成后显示时长
        videoPlayer.addEventListener('loadedmetadata', function() {
            const duration = formatTime(videoPlayer.duration);
            videoDuration.textContent = duration;
        });
        
        // 视频加载错误
        videoPlayer.addEventListener('error', function() {
            showToast('视频加载失败，请尝试选择其他视频', 'error');
        });
        
        // 视频播放结束
        videoPlayer.addEventListener('ended', function() {
            playBtn.innerHTML = '<i class="fas fa-play"></i> 播放';
        });
    }
    
    // 设置控制按钮事件
    function setupControlEvents() {
        // 播放按钮
        playBtn.addEventListener('click', function() {
            if (videoPlayer.paused) {
                videoPlayer.play();
                playBtn.innerHTML = '<i class="fas fa-play"></i> 播放中';
            }
        });
        
        // 暂停按钮
        pauseBtn.addEventListener('click', function() {
            if (!videoPlayer.paused) {
                videoPlayer.pause();
                playBtn.innerHTML = '<i class="fas fa-play"></i> 播放';
            }
        });
        
        // 停止按钮
        stopBtn.addEventListener('click', function() {
            videoPlayer.pause();
            videoPlayer.currentTime = 0;
            playBtn.innerHTML = '<i class="fas fa-play"></i> 播放';
        });
        
        // 全屏按钮
        fullscreenBtn.addEventListener('click', function() {
            if (videoPlayer.requestFullscreen) {
                videoPlayer.requestFullscreen();
            } else if (videoPlayer.webkitRequestFullscreen) { /* Safari */
                videoPlayer.webkitRequestFullscreen();
            } else if (videoPlayer.msRequestFullscreen) { /* IE11 */
                videoPlayer.msRequestFullscreen();
            }
        });
        
        // 播放速度选择
        speedSelect.addEventListener('change', function() {
            videoPlayer.playbackRate = parseFloat(this.value);
        });
        
        // 给每个视频项添加点击事件
        if (videoList) {
            const videoItems = videoList.querySelectorAll('.video-item');
            videoItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // 不触发操作按钮的点击事件
                    if (e.target.closest('.video-actions')) return;
                    selectVideo(this);
                });
            });
        }
    }
    
    // 选择视频
    function selectVideo(videoItem) {
        // 移除之前选中项的激活状态
        if (currentVideo) {
            currentVideo.classList.remove('active');
        }
        
        // 设置当前选中视频
        currentVideo = videoItem;
        currentVideo.classList.add('active');
        
        // 获取视频信息
        const videoPath = currentVideo.dataset.path;
        const videoFile = currentVideo.dataset.file;
        const videoDateStr = currentVideo.dataset.date;
        const videoSizeStr = currentVideo.dataset.size;
        
        // 更新播放器
        videoPlayer.src = videoPath;
        currentVideoTitle.textContent = videoFile;
        videoDate.textContent = videoDateStr;
        videoSize.textContent = videoSizeStr;
        
        // 重置播放按钮
        playBtn.innerHTML = '<i class="fas fa-play"></i> 播放';
        
        // 自动播放
        videoPlayer.load();
        
        // 滚动到视图中
        currentVideo.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // 确认删除视频
    function confirmDelete(filename) {
        deleteFileName.textContent = filename;
        confirmDeleteBtn.onclick = function() {
            deleteVideo(filename);
        };
        openModal();
    }
    
    // 删除视频
    function deleteVideo(filename) {
        fetch(`/check/api/playback/delete/${filename}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 查找并移除列表项
                const videoItem = document.querySelector(`.video-item[data-file="${filename}"]`);
                if (videoItem) {
                    // 如果删除的是当前播放的视频，则停止播放
                    if (currentVideo === videoItem) {
                        videoPlayer.src = '';
                        currentVideoTitle.textContent = '监控视频回放';
                        videoDate.textContent = '--';
                        videoSize.textContent = '--';
                        videoDuration.textContent = '--:--';
                        currentVideo = null;
                    }
                    
                    // 从列表中移除
                    videoItem.remove();
                    
                    // 更新计数
                    const videoCount = document.querySelector('.video-count');
                    const count = document.querySelectorAll('.video-item').length;
                    videoCount.textContent = `${count} 个记录`;
                    
                    // 如果没有视频了，显示空状态
                    if (count === 0) {
                        videoList.innerHTML = '';
                        const noRecords = document.createElement('div');
                        noRecords.className = 'no-records';
                        noRecords.innerHTML = `
                            <div class="no-records-icon">
                                <i class="fas fa-video-slash"></i>
                            </div>
                            <p class="no-records-text">暂无回放记录</p>
                            <p class="no-records-hint">开始视频监控并保存记录后可在此查看</p>
                            <a href="{{ url_for('check.monitor') }}" class="no-records-btn">
                                <i class="fas fa-video"></i> 前往视频监控
                            </a>
                        `;
                        document.querySelector('.video-list-container').appendChild(noRecords);
                    } else {
                        // 如果列表中还有视频，选中第一个
                        const firstVideo = document.querySelector('.video-item');
                        if (firstVideo) {
                            selectVideo(firstVideo);
                        }
                    }
                    
                    showToast('视频删除成功', 'success');
                }
            } else {
                showToast(data.message || '删除失败', 'error');
            }
            
            closeModal();
        })
        .catch(error => {
            console.error('删除视频时出错:', error);
            showToast('删除请求失败', 'error');
            closeModal();
        });
    }
    
    // 下载视频
    function downloadVideo(path, filename) {
        // 创建一个临时链接用于下载
        const a = document.createElement('a');
        a.href = path;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    // 格式化时间
    function formatTime(seconds) {
        if (isNaN(seconds)) return '--:--';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hours > 0) {
            return `${padZero(hours)}:${padZero(minutes)}:${padZero(secs)}`;
        } else {
            return `${padZero(minutes)}:${padZero(secs)}`;
        }
    }
    
    // 数字补零
    function padZero(num) {
        return num.toString().padStart(2, '0');
    }
    
    // 显示弹窗
    function openModal() {
        deleteModal.classList.add('visible');
    }
    
    // 关闭弹窗
    function closeModal() {
        deleteModal.classList.remove('visible');
    }
    
    // 显示提示消息
    function showToast(message, type = 'success') {
        toast.textContent = message;
        toast.className = 'toast';
        toast.classList.add(type);
        toast.classList.add('show');
        
        setTimeout(function() {
            toast.classList.remove('show');
        }, 3000);
    }
</script>
{% endblock %} 