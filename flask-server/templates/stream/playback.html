{% extends "common/front_base.html" %}

{% block title %}【HorizonSafe 界安】 - 监控回放{% endblock %}

{% block css %}
<style>
    /* 页面样式 */
    .page-header {
        margin-bottom: 30px;
    }
    
    .page-header h1 {
        font-size: 2.2rem;
        margin-bottom: 10px;
    }
    
    .page-header .subtitle {
        color: #6c757d;
        font-size: 1.1rem;
    }
    
    /* 过滤和搜索区域 */
    .filters-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .filter-item {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-label {
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
    }
    
    .tag-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .tag-badge {
        background-color: #e9ecef;
        color: #495057;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tag-badge:hover {
        background-color: #dee2e6;
    }
    
    .tag-badge.active {
        background-color: #007bff;
        color: white;
    }
    
    /* 视频列表 */
    .videos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .video-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: white;
    }
    
    .video-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .video-thumbnail {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 比例 */
        background-color: #f8f9fa;
        overflow: hidden;
    }
    
    .video-thumbnail img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .video-thumbnail .play-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 3rem;
        opacity: 0.8;
        transition: opacity 0.3s;
    }
    
    .video-card:hover .play-icon {
        opacity: 1;
    }
    
    .video-info {
        padding: 15px;
    }
    
    .video-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .video-metadata {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .video-metadata-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .video-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 10px;
    }
    
    .video-tag {
        background-color: #e9ecef;
        color: #495057;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    .video-actions {
        padding: 15px;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* 分页控件 */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin: 30px 0;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }
    
    /* 空状态 */
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin: 30px 0;
    }
    
    .empty-state i {
        font-size: 3rem;
        color: #adb5bd;
        margin-bottom: 20px;
    }
    
    .empty-state h3 {
        margin-bottom: 15px;
        color: #495057;
    }
    
    .empty-state p {
        color: #6c757d;
        max-width: 500px;
        margin: 0 auto 20px;
    }
    
    /* 加载状态 */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
    }
    
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #007bff;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* 视频播放器模态框 */
    .modal-xl {
        max-width: 1200px;
    }
    
    .video-player-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 比例 */
        background-color: black;
    }
    
    .video-player-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    .player-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        padding: 10px 15px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .video-player-container:hover .player-controls {
        opacity: 1;
    }
    
    .controls-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    
    .control-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    
    .control-btn:hover {
        opacity: 1;
    }
    
    .progress-bar {
        width: 100%;
        height: 5px;
        background-color: rgba(255,255,255,0.3);
        border-radius: 2px;
        cursor: pointer;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background-color: #007bff;
        width: 0;
    }
    
    .time-display {
        color: white;
        font-size: 0.9rem;
        margin-left: 10px;
    }
    
    .detection-info {
        background-color: rgba(0,0,0,0.6);
        color: white;
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .detection-count {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    /* 视频详情面板 */
    .video-details {
        padding: 20px;
    }
    
    .detail-section {
        margin-bottom: 20px;
    }
    
    .detail-title {
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .detail-content {
        color: #495057;
    }
    
    .detection-table {
        width: 100%;
        margin-top: 10px;
    }
    
    .detection-table th, .detection-table td {
        padding: 8px 12px;
        text-align: left;
    }
    
    .detection-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .detection-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .add-tag-form {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .add-tag-form input {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-history"></i> 监控回放</h1>
                <p class="subtitle">查看和管理所有已记录的监控视频，包括检测结果和统计信息。</p>
            </div>
            <div>
                <button type="button" id="sync_videos_btn" class="btn btn-outline-primary">
                    <i class="fas fa-sync"></i> 同步视频库
                </button>
            </div>
        </div>
    </div>
    
    <div class="filters-section">
        <div class="filter-row">
            <div class="filter-item">
                <label class="filter-label">时间范围</label>
                <div class="input-group">
                    <input type="date" id="date_from" class="form-control" placeholder="开始日期">
                    <div class="input-group-append input-group-prepend">
                        <span class="input-group-text">至</span>
                    </div>
                    <input type="date" id="date_to" class="form-control" placeholder="结束日期">
                </div>
            </div>
            <div class="filter-item">
                <label class="filter-label">搜索</label>
                <input type="text" id="search_input" class="form-control" placeholder="输入文件名或内容搜索...">
            </div>
            </div>
            
        <div class="filter-row">
            <div class="filter-item">
                <label class="filter-label">标签筛选</label>
                <div class="tag-filter" id="tag_filter">
                    <span class="tag-badge active" data-tag="">全部</span>
                    <span class="tag-badge" data-tag="检测">检测</span>
                    <span class="tag-badge" data-tag="人流量">人流量</span>
                    <span class="tag-badge" data-tag="异常">异常</span>
                    <span class="tag-badge" data-tag="重要">重要</span>
                </div>
            </div>
            <div class="filter-item" style="display: flex; align-items: flex-end;">
                <button type="button" id="filter_button" class="btn btn-primary" style="margin-left: auto;">
                    <i class="fas fa-filter"></i> 应用筛选
                </button>
                <button type="button" id="reset_filter_button" class="btn btn-secondary ml-2">
                    <i class="fas fa-redo"></i> 重置
                </button>
            </div>
        </div>
    </div>
    
    <div id="loading_container" class="loading">
        <div class="spinner"></div>
    </div>
    
    <div id="empty_state" class="empty-state" style="display: none;">
        <i class="fas fa-video-slash"></i>
        <h3>没有找到监控视频</h3>
        <p>当前没有符合筛选条件的监控视频记录。尝试调整筛选条件或者检查系统是否正确保存了监控记录。</p>
        <div id="error_details" class="mt-3 mb-3" style="color: #dc3545; text-align: left; max-width: 600px; margin: 0 auto; display: none;">
            <h5><i class="fas fa-exclamation-triangle"></i> 错误详情</h5>
            <pre id="error_message" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9rem; white-space: pre-wrap; text-align: left;"></pre>
        </div>
        <div class="mt-2">
            <button type="button" id="check_system_btn" class="btn btn-primary">
                <i class="fas fa-sync"></i> 检查监控系统
            </button>
            <button type="button" id="debug_info_btn" class="btn btn-info ml-2">
                <i class="fas fa-bug"></i> 显示调试信息
            </button>
        </div>
    </div>
    
    <div id="videos_container" style="display: none;">
        <div class="videos-grid" id="videos_grid">
            <!-- 视频卡片将在这里动态加载 -->
        </div>
        
        <div class="pagination-container">
            <ul class="pagination" id="pagination">
                <!-- 分页控件将在这里动态加载 -->
            </ul>
        </div>
                </div>
            </div>
            
<!-- 视频播放模态框 -->
<div class="modal fade" id="videoPlayerModal" tabindex="-1" role="dialog" aria-labelledby="videoPlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoPlayerModalLabel">视频回放</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                    </div>
            <div class="modal-body p-0">
                <div class="row no-gutters">
                    <div class="col-md-8">
                        <div class="video-player-container">
                            <video id="video_player" controls>
                                您的浏览器不支持HTML5视频播放
                            </video>
                            <div class="detection-info" id="detection_info">
                                <!-- 检测信息将在这里显示 -->
                    </div>
                    </div>
                </div>
                    <div class="col-md-4">
                        <div class="video-details">
                            <div class="detail-section">
                                <div class="detail-title">
                                    <i class="fas fa-info-circle"></i> 基本信息
            </div>
                                <div class="detail-content" id="video_basic_info">
                                    <!-- 基本信息将在这里显示 -->
        </div>
            </div>
            
                            <div class="detail-section">
                                <div class="detail-title">
                                    <i class="fas fa-tag"></i> 标签
                        </div>
                                <div class="detail-content">
                                    <div class="video-tags" id="video_tags">
                                        <!-- 标签将在这里显示 -->
                        </div>
                                    <div class="add-tag-form">
                                        <input type="text" id="new_tag_input" class="form-control" placeholder="添加新标签...">
                                        <button type="button" id="add_tag_button" class="btn btn-sm btn-primary">添加</button>
                    </div>
                    </div>
                </div>
                            
                            <div class="detail-section">
                                <div class="detail-title">
                                    <i class="fas fa-chart-bar"></i> 检测统计
            </div>
                                <div class="detail-content" id="detection_stats">
                                    <!-- 检测统计将在这里显示 -->
        </div>
    </div>
</div>
        </div>
                </div>
        </div>
        <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="delete_video_btn">
                    <i class="fas fa-trash-alt"></i> 删除视频
                </button>
                <a href="#" class="btn btn-success" id="download_video_btn" download>
                    <i class="fas fa-download"></i> 下载视频
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 全局变量
    let currentPage = 1;
    let totalPages = 1;
    let selectedTag = '';
    let currentVideoId = '';
    let debugMode = false;
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 初始加载视频列表
        loadVideos(1);
        
        // 添加调试按钮事件
        document.getElementById('debug_info_btn').addEventListener('click', function() {
            const errorDetails = document.getElementById('error_details');
            if (errorDetails.style.display === 'none') {
                errorDetails.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏调试信息';
                debugMode = true;
            } else {
                errorDetails.style.display = 'none';
                this.innerHTML = '<i class="fas fa-bug"></i> 显示调试信息';
                debugMode = false;
            }
        });
        
        // 添加检查监控系统按钮事件
        document.getElementById('check_system_btn').addEventListener('click', function() {
            checkMonitoringSystem();
        });
        
        // 添加同步视频库按钮事件
        document.getElementById('sync_videos_btn').addEventListener('click', function() {
            syncVideoLibrary();
        });
        
        // 标签筛选点击事件
        document.getElementById('tag_filter').addEventListener('click', function(e) {
            if (e.target.classList.contains('tag-badge')) {
                // 移除其他标签的激活状态
                document.querySelectorAll('.tag-badge').forEach(tag => {
                    tag.classList.remove('active');
                });
                
                // 激活当前标签
                e.target.classList.add('active');
                
                // 更新选中的标签
                selectedTag = e.target.getAttribute('data-tag');
            }
        });
        
        // 筛选按钮点击事件
        document.getElementById('filter_button').addEventListener('click', function() {
            currentPage = 1;
            loadVideos(currentPage);
        });
        
        // 重置筛选按钮点击事件
        document.getElementById('reset_filter_button').addEventListener('click', function() {
            // 重置筛选条件
            document.getElementById('date_from').value = '';
            document.getElementById('date_to').value = '';
            document.getElementById('search_input').value = '';
            
            // 重置标签选择
            document.querySelectorAll('.tag-badge').forEach(tag => {
                tag.classList.remove('active');
            });
            document.querySelector('.tag-badge[data-tag=""]').classList.add('active');
            selectedTag = '';
            
            // 重新加载视频
            currentPage = 1;
            loadVideos(currentPage);
        });
        
        // 添加标签按钮点击事件
        document.getElementById('add_tag_button').addEventListener('click', function() {
            addTag();
        });
        
        // 标签输入框回车事件
        document.getElementById('new_tag_input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag();
            }
        });
        
        // 删除视频按钮点击事件
        document.getElementById('delete_video_btn').addEventListener('click', function() {
            if (confirm('确定要删除这个视频吗？此操作不可恢复！')) {
                deleteVideo(currentVideoId);
            }
        });
        
        // 视频播放器事件处理
        const videoPlayer = document.getElementById('video_player');
        videoPlayer.addEventListener('play', function() {
            console.log('视频开始播放');
        });
        
        // 模态框关闭时暂停视频
        $('#videoPlayerModal').on('hidden.bs.modal', function () {
            videoPlayer.pause();
        });
    });
    
    // 检查监控系统
    function checkMonitoringSystem() {
        const errorMessage = document.getElementById('error_message');
        
        // 显示加载状态
        document.getElementById('loading_container').style.display = 'flex';
        document.getElementById('videos_container').style.display = 'none';
        document.getElementById('empty_state').style.display = 'none';
        
        // 发送API请求检查系统状态
        fetch('/check/healthcheck')
            .then(response => response.json())
            .then(data => {
                console.log('监控系统状态:', data);
                errorMessage.textContent = JSON.stringify(data, null, 2);
                
                // 同步视频库
                return syncVideoLibrary();
            })
            .catch(error => {
                console.error('检查监控系统失败:', error);
                errorMessage.textContent = '检查监控系统失败: ' + error.message;
                
                // 显示空状态和错误信息
                document.getElementById('loading_container').style.display = 'none';
                document.getElementById('empty_state').style.display = 'block';
                if (debugMode) {
                    document.getElementById('error_details').style.display = 'block';
                }
            });
    }
    
    // 同步视频库
    function syncVideoLibrary() {
        // 显示加载状态
        document.getElementById('loading_container').style.display = 'flex';
        
        // 调用同步API
        return fetch('/stream/api/playback/videos?sync=true')
            .then(response => response.json())
            .then(data => {
                // 处理响应
                console.log('同步视频库结果:', data);
                
                if (data.status === 'success') {
                    // 重新加载视频列表
                    loadVideos(currentPage);
                } else {
                    // 显示错误信息
                    const errorMessage = document.getElementById('error_message');
                    errorMessage.textContent = JSON.stringify(data, null, 2);
                    
                    document.getElementById('loading_container').style.display = 'none';
                    document.getElementById('empty_state').style.display = 'block';
                    if (debugMode) {
                        document.getElementById('error_details').style.display = 'block';
                    }
                }
                
                return data;
            })
            .catch(error => {
                console.error('同步视频库失败:', error);
                const errorMessage = document.getElementById('error_message');
                errorMessage.textContent = '同步视频库失败: ' + error.message;
                
                document.getElementById('loading_container').style.display = 'none';
                document.getElementById('empty_state').style.display = 'block';
                if (debugMode) {
                    document.getElementById('error_details').style.display = 'block';
                }
                
                throw error;
            });
    }
    
    // 加载视频列表
    function loadVideos(page) {
        // 显示加载状态
        document.getElementById('loading_container').style.display = 'flex';
        document.getElementById('videos_container').style.display = 'none';
        document.getElementById('empty_state').style.display = 'none';
        
        // 获取筛选条件
        const dateFrom = document.getElementById('date_from').value;
        const dateTo = document.getElementById('date_to').value;
        const searchTerm = document.getElementById('search_input').value;
        
        // 构建请求URL
        let url = `/stream/api/playback/videos?page=${page}&limit=12`;
        if (selectedTag) {
            url += `&tag=${encodeURIComponent(selectedTag)}`;
        }
        if (dateFrom) {
            url += `&date_from=${encodeURIComponent(dateFrom)}`;
        }
        if (dateTo) {
            url += `&date_to=${encodeURIComponent(dateTo)}`;
        }
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        console.log('加载视频URL:', url);
        
        // 发送请求
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // 隐藏加载状态
                document.getElementById('loading_container').style.display = 'none';
                
                // 调试信息
                console.log('视频列表响应:', data);
                if (debugMode) {
                    const errorMessage = document.getElementById('error_message');
                    errorMessage.textContent = JSON.stringify(data, null, 2);
                }
                
                if (data.status === 'success' && data.data && data.data.length > 0) {
                    // 显示视频容器
                    document.getElementById('videos_container').style.display = 'block';
                    
                    // 更新视频网格
                    renderVideos(data.data);
                    
                    // 更新分页
                    if (data.pagination) {
                        totalPages = data.pagination.pages;
                        currentPage = data.pagination.page;
                        renderPagination(data.pagination);
                    }
                } else {
                    // 显示空状态
                    document.getElementById('empty_state').style.display = 'block';
                    
                    // 如果处于调试模式，显示错误详情
                    if (debugMode) {
                        document.getElementById('error_details').style.display = 'block';
                    }
                }
            })
            .catch(error => {
                console.error('加载视频失败:', error);
                const errorMessage = document.getElementById('error_message');
                errorMessage.textContent = '加载视频失败: ' + error.message;
                
                document.getElementById('loading_container').style.display = 'none';
                document.getElementById('empty_state').style.display = 'block';
                
                // 如果处于调试模式，显示错误详情
                if (debugMode) {
                    document.getElementById('error_details').style.display = 'block';
                }
            });
    }
    
    // 渲染视频列表
    function renderVideos(videos) {
        const videosGrid = document.getElementById('videos_grid');
        videosGrid.innerHTML = '';
        
        videos.forEach(video => {
            // 创建视频卡片
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card';
            
            // 提取视频ID
            const videoId = video.id;
            
            // 构建视频缩略图
            const thumbnailUrl = video.thumbnail_url || `/static/img/video-thumbnail.jpg`; // 使用视频缩略图或默认图片
            
            // 计算视频创建时间
            let createdDate;
            try {
                createdDate = new Date(video.created_at);
            } catch (e) {
                createdDate = new Date();
                console.error('解析创建时间失败:', e);
            }
            const formattedDate = createdDate.toLocaleDateString();
            const formattedTime = createdDate.toLocaleTimeString();
            
            // 构建标签HTML
            let tagsHtml = '';
            if (video.tags && video.tags.length > 0) {
                video.tags.forEach(tag => {
                    tagsHtml += `<span class="video-tag">${tag}</span>`;
                });
            }
            
            // 组装HTML
            videoCard.innerHTML = `
                <div class="video-thumbnail">
                    <img src="${thumbnailUrl}" alt="${video.filename}" onerror="this.src='/static/img/video-thumbnail.jpg'">
                    <div class="play-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                </div>
                <div class="video-info">
                    <div class="video-title">${video.original_filename || video.filename}</div>
                    <div class="video-metadata">
                        <div class="video-metadata-item">
                            <i class="fas fa-calendar"></i> ${formattedDate}
                        </div>
                        <div class="video-metadata-item">
                            <i class="fas fa-clock"></i> ${formattedTime}
                        </div>
                    </div>
                    <div class="video-metadata">
                        <div class="video-metadata-item">
                            <i class="fas fa-film"></i> ${video.duration || '00:00:00'}
                        </div>
                        <div class="video-metadata-item">
                            <i class="fas fa-hdd"></i> ${video.size}
                        </div>
                    </div>
                    ${video.total_detections ? `
                    <div class="video-metadata">
                        <div class="video-metadata-item">
                            <i class="fas fa-eye"></i> 检测对象: ${video.total_detections}
                        </div>
                    </div>
                    ` : ''}
                    <div class="video-tags">
                        ${tagsHtml}
                    </div>
                </div>
                <div class="video-actions">
                    <button type="button" class="btn btn-sm btn-primary play-video-btn" data-video-id="${videoId}">
                        <i class="fas fa-play"></i> 播放
                    </button>
                    <button type="button" class="btn btn-sm btn-danger delete-video-btn" data-video-id="${videoId}">
                        <i class="fas fa-trash-alt"></i> 删除
                    </button>
                </div>
            `;
            
            // 添加播放按钮点击事件
            videoCard.querySelector('.play-video-btn').addEventListener('click', function() {
                openVideoPlayer(videoId);
            });
            
            // 添加删除按钮点击事件
            videoCard.querySelector('.delete-video-btn').addEventListener('click', function() {
                if (confirm('确定要删除这个视频吗？此操作不可恢复！')) {
                    deleteVideo(videoId);
                }
            });
            
            // 添加缩略图点击事件
            videoCard.querySelector('.video-thumbnail').addEventListener('click', function() {
                openVideoPlayer(videoId);
            });
            
            // 将卡片添加到网格
            videosGrid.appendChild(videoCard);
        });
    }
    
    // 渲染分页控件
    function renderPagination(pagination) {
        const paginationElement = document.getElementById('pagination');
        paginationElement.innerHTML = '';
        
        // 上一页按钮
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${pagination.page <= 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
        if (pagination.page > 1) {
            prevLi.addEventListener('click', function(e) {
                e.preventDefault();
                loadVideos(pagination.page - 1);
            });
        }
        paginationElement.appendChild(prevLi);
        
        // 页码按钮
        const totalPages = pagination.pages;
        const currentPage = pagination.page;
        
        // 显示页码的逻辑（最多显示5个页码）
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageLi.addEventListener('click', function(e) {
                e.preventDefault();
                loadVideos(i);
            });
            paginationElement.appendChild(pageLi);
        }
        
        // 下一页按钮
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${pagination.page >= pagination.pages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
        if (pagination.page < pagination.pages) {
            nextLi.addEventListener('click', function(e) {
                e.preventDefault();
                loadVideos(pagination.page + 1);
            });
        }
        paginationElement.appendChild(nextLi);
    }
    
    // 打开视频播放器
    function openVideoPlayer(videoId) {
        // 保存当前视频ID
        currentVideoId = videoId;
        
        // 获取视频详情
        fetch(`/stream/api/playback/video/${videoId}`)
        .then(response => response.json())
        .then(data => {
                if (data.status === 'success' && data.data) {
                    const video = data.data;
                    
                    // 设置模态框标题
                    document.getElementById('videoPlayerModalLabel').textContent = video.original_filename || video.filename;
                    
                    // 设置视频源
                    const videoPlayer = document.getElementById('video_player');
                    videoPlayer.src = video.url;
                    
                    // 设置下载链接
                    document.getElementById('download_video_btn').href = video.url;
                    document.getElementById('download_video_btn').download = video.original_filename || video.filename;
                    
                    // 更新基本信息
                    const basicInfoElement = document.getElementById('video_basic_info');
                    basicInfoElement.innerHTML = `
                        <div><strong>文件名:</strong> ${video.original_filename || video.filename}</div>
                        <div><strong>创建时间:</strong> ${video.created_at}</div>
                        <div><strong>时长:</strong> ${video.duration || '未知'}</div>
                        <div><strong>大小:</strong> ${video.size}</div>
                    `;
                    
                    // 更新标签
                    updateVideoTags(video.tags || []);
                    
                    // 更新检测统计
                    const detectionStatsElement = document.getElementById('detection_stats');
                    const detectionResults = video.detection_results || {};
                    
                    if (Object.keys(detectionResults).length > 0) {
                        let tableHtml = `
                            <table class="detection-table">
                                <thead>
                                    <tr>
                                        <th>类别</th>
                                        <th>数量</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        for (const [className, count] of Object.entries(detectionResults)) {
                            tableHtml += `
                                <tr>
                                    <td>${className}</td>
                                    <td>${count}</td>
                                </tr>
                            `;
                        }
                        
                        tableHtml += `
                                </tbody>
                            </table>
                        `;
                        
                        detectionStatsElement.innerHTML = tableHtml;
                        
                        // 更新检测信息面板
                        const detectionInfoElement = document.getElementById('detection_info');
                        detectionInfoElement.innerHTML = '';
                        
                        for (const [className, count] of Object.entries(detectionResults)) {
                            const detectionCount = document.createElement('div');
                            detectionCount.className = 'detection-count';
                            detectionCount.innerHTML = `
                                <i class="fas fa-eye"></i>
                                <span>${className}: ${count}</span>
                            `;
                            detectionInfoElement.appendChild(detectionCount);
                        }
                        
                        // 显示检测信息面板
                        detectionInfoElement.style.display = 'flex';
            } else {
                        detectionStatsElement.innerHTML = '<p>没有可用的检测统计信息</p>';
                        document.getElementById('detection_info').style.display = 'none';
                    }
                    
                    // 显示模态框
                    $('#videoPlayerModal').modal('show');
                    
                    // 自动播放视频
                    videoPlayer.play().catch(e => {
                        console.warn('自动播放失败:', e);
                    });
                }
        })
        .catch(error => {
                console.error('获取视频详情失败:', error);
                alert('获取视频详情失败，请重试');
            });
    }
    
    // 更新视频标签
    function updateVideoTags(tags) {
        const tagsContainer = document.getElementById('video_tags');
        tagsContainer.innerHTML = '';
        
        if (tags.length === 0) {
            tagsContainer.innerHTML = '<p>暂无标签</p>';
            return;
        }
        
        tags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'video-tag';
            tagElement.textContent = tag;
            tagsContainer.appendChild(tagElement);
        });
    }
    
    // 添加标签
    function addTag() {
        const tagInput = document.getElementById('new_tag_input');
        const newTag = tagInput.value.trim();
        
        if (!newTag) {
            return;
        }
        
        if (!currentVideoId) {
            alert('请先选择一个视频');
            return;
        }
        
        // 发送添加标签请求
        fetch('/stream/api/playback/tag', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_id: currentVideoId,
                tag: newTag
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 更新标签显示
                updateVideoTags(data.tags);
                
                // 清空输入框
                tagInput.value = '';
            } else {
                alert('添加标签失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('添加标签失败:', error);
            alert('添加标签失败，请重试');
        });
    }
    
    // 删除视频
    function deleteVideo(videoId) {
        fetch(`/stream/api/playback/delete/${videoId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 如果正在播放的视频被删除，关闭模态框
                if (currentVideoId === videoId) {
                    $('#videoPlayerModal').modal('hide');
                }
                
                // 重新加载视频列表
                loadVideos(currentPage);
            } else {
                alert('删除视频失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('删除视频失败:', error);
            alert('删除视频失败，请重试');
        });
    }
</script>
{% endblock %} 